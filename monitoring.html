<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitoring - Tier One Advisory Philippines Inc.</title>

    <!-- Tailwind CSS with Line Clamp Plugin -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/line-clamp@0.4.2/browser/index.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      .header-gradient {
        background: linear-gradient(135deg, #0056a3 0%, #003d75 100%);
      }
      .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .lightbox-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .task-card {
        transition: all 0.3s ease;
      }
      .task-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      }
      /* Sage Green Background Gradient */
      body {
        background: linear-gradient(135deg, #9dc183 0%, #7d9a68 100%);
        min-height: 100vh;
      }
      /* Random Card Background Colors with proper text contrast */
      .card-bg-1 { background-color: #3b82f6; color: white; }  /* Blue */
      .card-bg-2 { background-color: #ef4444; color: white; }  /* Red */
      .card-bg-3 { background-color: #10b981; color: white; }  /* Green */
      .card-bg-4 { background-color: #f59e0b; color: black; }  /* Yellow */
      .card-bg-5 { background-color: #8b5cf6; color: white; }  /* Purple */
      .card-bg-6 { background-color: #ec4899; color: white; }  /* Pink */
      .card-bg-7 { background-color: #06b6d4; color: white; }  /* Cyan */
      .card-bg-8 { background-color: #84cc16; color: black; }  /* Lime */
      .card-bg-9 { background-color: #f97316; color: white; }  /* Orange */
      .card-bg-10 { background-color: #6366f1; color: white; } /* Indigo */
      .card-bg-11 { background-color: #14b8a6; color: white; } /* Teal */
      .card-bg-12 { background-color: #fbbf24; color: black; } /* Amber */
      /* Search Modal */
      .search-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .search-modal-content {
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 500px;
      }

      /* Improved Header Styles inspired by SGS */
      .compact-header {
        padding: 0.75rem 0;
      }

      .compact-nav {
        padding: 0.5rem 0;
      }

      .tighter-margins {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* SGS-inspired navigation */
      .nav-item {
        position: relative;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Compact spacing */
      .compact-spacing {
        margin-bottom: 1.5rem;
      }

      .section-padding {
        padding: 1.5rem 0;
      }

      /* Improved mobile responsiveness */
      @media (max-width: 768px) {
        .tighter-margins {
          padding: 0 1rem;
        }
        
        .compact-header {
          padding: 0.5rem 0;
        }
        
        .nav-item {
          padding: 0.5rem 0.75rem;
          font-size: 0.8rem;
        }
      }

      /* Tighten up existing components */
      .stats-card {
        padding: 1rem;
      }

      .quick-action-card {
        padding: 1.5rem;
      }
      
      .refresh-spin {
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      .custom-notification {
        transform: translateX(100%);
        opacity: 0;
      }
      
      .custom-notification.translate-x-0 {
        transform: translateX(0);
        opacity: 1;
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-[#9dc183] to-[#7d9a68]">
    <!-- Search Modal -->
    <div id="searchModal" class="search-modal">
      <div class="search-modal-content">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-800">Search Requests</h3>
          <button id="closeSearch" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="relative">
          <input type="text" id="globalSearch" placeholder="Search by client, category, document type..." 
                 class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
        <div class="mt-4">
          <button onclick="performGlobalSearch()" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition-all duration-200 font-medium">
            <i class="fas fa-search mr-2"></i>Search
          </button>
        </div>
      </div>
    </div>

    <!-- Enhanced Compact Header -->
    <header class="bg-white shadow-sm">
      <!-- Top Bar - Made more compact -->
      <div class="bg-gray-800 text-white py-1.5 text-xs">
        <div class="tighter-margins px-4">
          <div class="flex justify-between items-center">
            <div class="flex space-x-3">
              <a href="#" class="hover:text-blue-300 transition flex items-center">
                <i class="fas fa-globe mr-1 text-xs"></i> Philippines
              </a>
              <a href="#" class="hover:text-blue-300 transition flex items-center">
                <i class="fas fa-phone mr-1 text-xs"></i> Contact Us
              </a>
              <a href="#" onclick="logout()" class="hover:text-blue-300 transition cursor-pointer flex items-center">
                <i class="fas fa-sign-out-alt mr-1 text-xs"></i> Logout
              </a>
            </div>
            <div class="flex space-x-3">
              <a href="#" class="hover:text-blue-300 transition">
                <i class="fab fa-linkedin text-sm"></i>
              </a>
              <a href="#" class="hover:text-blue-300 transition">
                <i class="fab fa-twitter text-sm"></i>
              </a>
              <a href="#" class="hover:text-blue-300 transition">
                <i class="fab fa-facebook text-sm"></i>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Navigation - More compact like SGS -->
      <nav class="header-gradient text-white shadow-lg compact-nav">
        <div class="tighter-margins px-4">
          <div class="flex items-center justify-between">
            <!-- Company Logo & Name -->
            <div class="flex items-center space-x-6">
              <a href="dashboard.html" class="flex items-center space-x-2 text-xl font-bold text-white">
                <div class="w-8 h-8 bg-white rounded flex items-center justify-center">
                  <span class="text-blue-600 font-bold text-sm">T1</span>
                </div>
                <span class="hidden sm:block">Tier One Advisory Philippines Inc.</span>
              </a>
              
              <!-- Main Menu - More compact -->
              <div class="hidden md:flex space-x-0.5">
                <a href="dashboard.html" class="nav-item">
                  Dashboard
                </a>
                <a href="request-form.html" class="nav-item">
                  Request Form
                </a>
                <a href="search.html" class="nav-item">
                  Search
                </a>
                <a href="monitoring.html" class="nav-item active">
                  Monitoring
                </a>
                <a href="#" id="approvalsLink" class="nav-item">
                  Approvals
                </a>
              </div>
            </div>

            <!-- Right Side Actions - More compact -->
            <div class="flex items-center space-x-3">
              <button id="searchButton" class="p-1.5 hover:bg-white/10 rounded transition-all duration-200">
                <i class="fas fa-search text-sm"></i>
              </button>
              <div class="relative">
                <button class="flex items-center space-x-1.5 p-1.5 hover:bg-white/10 rounded transition-all duration-200">
                  <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-xs"></i>
                  </div>
                  <span id="userWelcome" class="text-xs font-medium hidden sm:block">Welcome!</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Compact Breadcrumb -->
      <div class="bg-gray-100 border-b text-xs">
        <div class="tighter-margins px-4 py-1.5">
          <nav>
            <ol class="list-none p-0 inline-flex">
              <li class="flex items-center">
                <a href="dashboard.html" class="text-blue-600 hover:text-blue-800">Home</a>
                <span class="mx-1.5 text-gray-400">/</span>
              </li>
              <li class="text-gray-500">Monitoring</li>
            </ol>
          </nav>
        </div>
      </div>
    </header>

    <!-- Monitoring Content -->
    <main class="tighter-margins px-4 py-6">
      <!-- Page Header with Refresh Button -->
      <div class="flex justify-between items-center compact-spacing">
        <div>
          <h1 class="text-2xl font-bold text-gray-800 mb-1" id="pageTitle">Request Monitoring</h1>
          <p class="text-gray-600 text-sm" id="pageSubtitle">Track and update request status in real-time</p>
        </div>
        <button id="refreshButton" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200 font-medium flex items-center space-x-1.5 text-sm">
          <i class="fas fa-sync-alt"></i>
          <span>Refresh Data</span>
        </button>
      </div>

      <!-- Stats Overview - Larger Fonts -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-red-500">
              <div class="flex items-center">
                  <div class="p-2 bg-red-100 rounded">
                      <i class="fas fa-clock text-red-600 text-lg"></i>
                  </div>
                  <div class="ml-3 flex-1 min-w-0">
                      <p class="text-xs text-gray-600 truncate">Pending</p>
                      <h3 class="text-3xl font-bold text-gray-800 truncate" id="pendingCount">0</h3>
                  </div>
              </div>
          </div>

          <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-yellow-500">
              <div class="flex items-center">
                  <div class="p-2 bg-yellow-100 rounded">
                      <i class="fas fa-spinner text-yellow-600 text-lg"></i>
                  </div>
                  <div class="ml-3 flex-1 min-w-0">
                      <p class="text-xs text-gray-600 truncate">In Progress</p>
                      <h3 class="text-3xl font-bold text-gray-800 truncate" id="inProgressCount">0</h3>
                  </div>
              </div>
          </div>

          <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-green-500">
              <div class="flex items-center">
                  <div class="p-2 bg-green-100 rounded">
                      <i class="fas fa-check-circle text-green-600 text-lg"></i>
                  </div>
                  <div class="ml-3 flex-1 min-w-0">
                      <p class="text-xs text-gray-600 truncate">Completed</p>
                      <h3 class="text-3xl font-bold text-gray-800 truncate" id="completedCount">0</h3>
                  </div>
              </div>
          </div>
      </div>

      <!-- Tasks Container -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-800">All Requests</h2>
          <div class="flex items-center space-x-3">
            <span class="text-xs text-gray-600" id="paginationInfo">Showing 0-0 of 0</span>
            <div class="flex space-x-1">
              <button id="prevPage" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-xs">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button id="nextPage" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-xs">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div id="tasksContainer" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          <!-- Tasks will be loaded here -->
          <div class="col-span-full text-center text-gray-500 py-6">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl mb-2"></i>
            <p class="text-sm">Loading requests...</p>
          </div>
        </div>

        <!-- Pagination Controls -->
        <div class="px-4 py-3 border-t border-gray-200 flex justify-between items-center">
          <span class="text-xs text-gray-600" id="pageInfo">Page 1 of 1</span>
          <div class="flex space-x-1">
            <button id="firstPage" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-xs" disabled>
              <i class="fas fa-angle-double-left"></i>
            </button>
            <button id="prevPageBottom" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-xs" disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <div id="pageNumbers" class="flex space-x-1">
              <!-- Page numbers will be generated here -->
            </div>
            <button id="nextPageBottom" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-xs" disabled>
              <i class="fas fa-chevron-right"></i>
            </button>
            <button id="lastPage" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-xs" disabled>
              <i class="fas fa-angle-double-right"></i>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Status Update Lightbox -->
    <div id="statusLightbox" class="lightbox">
      <div class="lightbox-content w-full max-w-sm">
        <div class="text-center">
          <i class="fas fa-sync-alt text-blue-600 text-2xl mb-3"></i>
          <h3 class="text-lg font-semibold text-gray-800 mb-2" id="lightboxTitle">Update Status</h3>
          <p class="text-gray-600 text-sm mb-4" id="lightboxMessage">Are you sure you want to update the status?</p>
          
          <div class="flex space-x-3 justify-center">
            <button id="confirmUpdate" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
              Yes, Update
            </button>
            <button id="cancelUpdate" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition text-sm">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- EDIT TASK LIGHTBOX -->
    <div id="editTaskLightbox" class="lightbox">
      <div class="lightbox-content w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-800">Edit Request</h3>
          <button id="closeEditLightbox" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="editTaskForm" class="space-y-4">
          <input type="hidden" id="editTaskId">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Client</label>
              <input type="text" id="editClient" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Sub-Client</label>
              <input type="text" id="editSubClient" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
              <input type="text" id="editCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Document Type</label>
              <input type="text" id="editDocumentType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select id="editStatus" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="pending">Pending</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
            <input type="date" id="editDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
            <textarea id="editNotes" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          
          <!-- Attachments Display -->
          <div id="editAttachmentsSection" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Attachments</label>
            <div id="editAttachmentsList" class="space-y-2">
              <!-- Attachments will be listed here -->
            </div>
          </div>
          
          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" id="cancelEditTask" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm">
              Cancel
            </button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
              <i class="fas fa-save mr-2"></i>Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer - More compact -->
    <footer class="bg-gray-800 text-white mt-8">
      <div class="tighter-margins px-4 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div>
            <h3 class="font-bold text-base mb-3">Company</h3>
            <ul class="space-y-1 text-sm">
              <li><a href="#" class="hover:text-blue-300 transition">About Us</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Leadership</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Careers</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">News</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-base mb-3">Services</h3>
            <ul class="space-y-1 text-sm">
              <li><a href="#" class="hover:text-blue-300 transition">All Services</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Industries</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Locations</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-base mb-3">Support</h3>
            <ul class="space-y-1 text-sm">
              <li><a href="#" class="hover:text-blue-300 transition">Contact Us</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Help Center</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-base mb-3">Connect</h3>
            <div class="flex space-x-3">
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-linkedin"></i></a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-twitter"></i></a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-facebook"></i></a>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-700 mt-6 pt-4 text-center text-xs text-gray-400">
          <p>&copy; 2024 Tier One Advisory Philippines Inc. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const { createClient } = supabase;
      const SUPABASE_URL = "https://webdmcvcbfeytwhzonem.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYmRtY3ZjYmZleXR3aHpvbmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMDc5ODYsImV4cCI6MjA3Nzg4Mzk4Nn0.QlZeRqYvbdqNfRKrq_MIB0VBSM4ZcyeVtD_9O9uFAI8";

      // Use session persistence for auth
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: false
        }
      });

      let currentTaskId = null;
      let currentNewStatus = null;
      let allTasks = [];
      let currentPage = 1;
      const tasksPerPage = 12;
      let currentUser = null;
      let isRefreshing = false;

      // ===== AUTHENTICATION & USER MANAGEMENT =====
      async function checkAuth() {
        try {
          console.log('Checking authentication...');
          
          // First check if we have a session
          const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
          
          if (sessionError) {
            console.error('Session error:', sessionError);
            redirectToLogin();
            return;
          }
          
          if (!session) {
            console.log('No active session found');
            redirectToLogin();
            return;
          }

          console.log('Session found for user:', session.user.email);
          
          // Get user profile
          const { data: profile, error: profileError } = await supabaseClient
            .from('user_profiles')
            .select('*')
            .eq('id', session.user.id)
            .single();
          
          if (profileError) {
            console.error('Profile error:', profileError);
            // Try to get user by email as fallback
            const { data: profileByEmail, error: emailError } = await supabaseClient
              .from('user_profiles')
              .select('*')
              .eq('email', session.user.email)
              .single();
              
            if (emailError || !profileByEmail) {
              console.error('No profile found for user');
              redirectToLogin();
              return;
            }
            
            currentUser = { ...session.user, ...profileByEmail };
          } else {
            currentUser = { ...session.user, ...profile };
          }

          console.log('Current user:', currentUser);
          
          // Check if user is approved
          if (currentUser.status !== 'approved') {
            console.log('User not approved, status:', currentUser.status);
            alert('❌ Your account is not approved. Please contact administrator.');
            await supabaseClient.auth.signOut();
            redirectToLogin();
            return;
          }

          // Update UI with user info
          updateUIForUserRole();
          
          // Load monitoring data
          loadTasks();
          
        } catch (error) {
          console.error('Authentication failed:', error);
          redirectToLogin();
        }
      }

      function redirectToLogin() {
        console.log('Redirecting to login...');
        window.location.href = 'index.html';
      }

      async function logout() {
        try {
          await supabaseClient.auth.signOut();
          redirectToLogin();
        } catch (error) {
          console.error('Logout error:', error);
          redirectToLogin();
        }
      }

      function updateUIForUserRole() {
        // Update user welcome message
        const userWelcome = document.getElementById('userWelcome');
        if (userWelcome) {
          userWelcome.textContent = `Welcome, ${currentUser.full_name || currentUser.email}!`;
        }

        // Update page title and subtitle
        const pageTitle = document.getElementById('pageTitle');
        const pageSubtitle = document.getElementById('pageSubtitle');
        
        if (currentUser.role === 'admin') {
          if (pageTitle) pageTitle.textContent = 'Admin Monitoring';
          if (pageSubtitle) pageSubtitle.textContent = `Track and manage all requests - ${currentUser.full_name || 'Administrator'}`;
        } else {
          if (pageTitle) pageTitle.textContent = 'My Request Monitoring';
          if (pageSubtitle) pageSubtitle.textContent = `Track your requests - ${currentUser.full_name || currentUser.email}`;
        }
        
        // Setup approvals link protection
        setupApprovalsLink();
      }

      function setupApprovalsLink() {
        const approvalsLink = document.getElementById('approvalsLink');
        if (approvalsLink) {
          approvalsLink.addEventListener('click', function(e) {
            if (currentUser && currentUser.role === 'admin') {
              // Admin can access approvals
              window.location.href = 'admin-approval.html';
            } else {
              // Non-admin gets error message
              e.preventDefault();
              alert('❌ Access Denied: Only administrators can access the Approvals page.');
            }
          });
        }
      }

      // ===== SEARCH MODAL FUNCTIONALITY =====
      document.getElementById('searchButton').addEventListener('click', function() {
        document.getElementById('searchModal').style.display = 'block';
      });

      document.getElementById('closeSearch').addEventListener('click', function() {
        document.getElementById('searchModal').style.display = 'none';
      });

      document.getElementById('searchModal').addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });

      function performGlobalSearch() {
        const searchTerm = document.getElementById('globalSearch').value.trim();
        if (searchTerm) {
          window.location.href = `search.html?q=${encodeURIComponent(searchTerm)}`;
        } else {
          window.location.href = 'search.html';
        }
      }

      // ===== MONITORING FUNCTIONALITY =====
      // Load all tasks with better error handling
      async function loadTasks() {
        try {
          console.log('Loading tasks from Supabase...');
          const { data: tasks, error } = await supabaseClient
            .from('tasks_database')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) {
            console.error('Supabase error loading tasks:', error);
            showError('Error loading tasks: ' + error.message);
            return;
          }

          console.log('Tasks loaded successfully:', tasks?.length || 0);
          allTasks = tasks || [];
          updateStats(allTasks);
          displayPage(1);
          
        } catch (error) {
          console.error('Unexpected error loading tasks:', error);
          showError('Unexpected error loading tasks: ' + error.message);
        }
      }

      // Display tasks for specific page
      function displayPage(page) {
        currentPage = page;
        const startIndex = (page - 1) * tasksPerPage;
        const endIndex = startIndex + tasksPerPage;
        const pageTasks = allTasks.slice(startIndex, endIndex);
        
        displayTasks(pageTasks);
        updatePagination();
      }

      // Display tasks as cards in grid - UPDATED WITH ADMIN-ONLY UPDATE BUTTONS
      function displayTasks(tasks) {
        const container = document.getElementById('tasksContainer');
        
        if (!tasks || tasks.length === 0) {
          container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-6"><i class="fas fa-inbox text-2xl mb-2"></i><p class="text-sm">No requests found</p></div>';
          return;
        }

        let tasksHtml = '';
        tasks.forEach((task, index) => {
          const statusColor = getStatusColor(task.status);
          const randomBgClass = getRandomBackgroundClass(index);
          
          // Safe property access with fallbacks
          const client = task.client || 'No Client';
          const subClient = task.subClient || 'General';
          const category = task.category || 'No Category';
          const documentType = task.documentType || 'No Type';
          const notes = task.notes || 'No additional notes';
          const status = task.status || 'pending';
          const requester = task.requester || 'System User';
          
          // Safe date formatting
          let formattedDate = 'No date';
          if (task.date) {
            try {
              const date = new Date(task.date);
              formattedDate = isNaN(date.getTime()) ? 'Invalid date' : date.toLocaleDateString();
            } catch (e) {
              formattedDate = 'Invalid date';
            }
          }
          
          tasksHtml += `
            <div class="task-card rounded-lg p-3 shadow-sm ${randomBgClass}" data-task-id="${task.id}">
              <!-- STATUS AT THE TOP -->
              <div class="flex justify-between items-center mb-2">
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                  ${status.toUpperCase()}
                </span>
                <!-- EDIT BUTTON - ONLY FOR ADMINS -->
                ${currentUser && currentUser.role === 'admin' ? `
                  <button onclick="showEditTask('${task.id}')" 
                          class="bg-white bg-opacity-20 backdrop-blur-sm px-2 py-1 rounded hover:bg-opacity-30 transition text-xs font-medium">
                    <i class="fas fa-edit mr-1"></i>Edit
                  </button>
                ` : ''}
              </div>
              
              <!-- CLIENT & SUBCLIENT - TIGHTER -->
              <div class="mb-2">
                <h3 class="text-sm font-semibold truncate" title="${client} - ${subClient}">${client} - ${subClient}</h3>
                <p class="text-xs opacity-80 mt-1">${formattedDate} • By: ${requester}</p>
              </div>
              
              <!-- CATEGORY & DOCUMENT TYPE - TIGHTER -->
              <div class="grid grid-cols-2 gap-1 mb-3">
                <div>
                  <p class="text-xs opacity-80">Category</p>
                  <p class="font-medium text-xs truncate">${category}</p>
                </div>
                <div>
                  <p class="text-xs opacity-80">Document</p>
                  <p class="font-medium text-xs truncate">${documentType}</p>
                </div>
              </div>
              
              <!-- LARGER NOTES SECTION -->
              <div class="mb-3">
                <p class="text-xs opacity-80 mb-1">Notes</p>
                <p class="text-sm line-clamp-3 min-h-[3rem]">${notes}</p>
              </div>
              
              <!-- UPDATE BUTTON - ONLY FOR ADMINS AND NON-COMPLETED TASKS -->
              ${currentUser && currentUser.role === 'admin' && status !== 'completed' ? `
                <div class="flex justify-end">
                  <button onclick="showStatusUpdate('${task.id}', '${status}')" 
                          class="bg-white bg-opacity-20 backdrop-blur-sm px-3 py-1 rounded hover:bg-opacity-30 transition text-xs font-medium">
                    <i class="fas fa-sync-alt mr-1"></i>Update
                  </button>
                </div>
              ` : ''}
            </div>
          `;
        });

        container.innerHTML = tasksHtml;
      }

      // ===== EDIT TASK FUNCTIONALITY =====
      // Show edit task lightbox
      async function showEditTask(taskId) {
        // Check if current user is admin
        if (!currentUser || currentUser.role !== 'admin') {
          alert('❌ Access Denied: Only administrators can edit requests.');
          return;
        }
        
        try {
          console.log('Loading task for editing:', taskId);
          
          // Get the specific task data
          const { data: task, error } = await supabaseClient
            .from('tasks_database')
            .select('*')
            .eq('id', taskId)
            .single();

          if (error) {
            console.error('Error loading task for edit:', error);
            alert('Error loading task data: ' + error.message);
            return;
          }

          // Populate the edit form
          document.getElementById('editTaskId').value = task.id;
          document.getElementById('editClient').value = task.client || '';
          document.getElementById('editSubClient').value = task.subClient || '';
          document.getElementById('editCategory').value = task.category || '';
          document.getElementById('editDocumentType').value = task.documentType || '';
          document.getElementById('editStatus').value = task.status || 'pending';
          document.getElementById('editNotes').value = task.notes || '';
          
          // Format date for input field
          if (task.date) {
            const date = new Date(task.date);
            if (!isNaN(date.getTime())) {
              document.getElementById('editDate').value = date.toISOString().split('T')[0];
            }
          }
          
          // Show attachments if they exist
          const attachmentsSection = document.getElementById('editAttachmentsSection');
          const attachmentsList = document.getElementById('editAttachmentsList');
          
          if (task.attachments && task.attachments.length > 0) {
            attachmentsSection.classList.remove('hidden');
            attachmentsList.innerHTML = task.attachments.map(att => `
              <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <div class="flex items-center">
                  <i class="fas fa-file mr-2 text-gray-500"></i>
                  <span class="text-sm">${att.name}</span>
                </div>
                <a href="${att.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                  <i class="fas fa-external-link-alt"></i>
                </a>
              </div>
            `).join('');
          } else {
            attachmentsSection.classList.add('hidden');
          }
          
          // Show the edit lightbox
          document.getElementById('editTaskLightbox').style.display = 'block';
          
        } catch (error) {
          console.error('Error in showEditTask:', error);
          alert('Error loading task for editing: ' + error.message);
        }
      }

      // Save edited task
      async function saveEditedTask(taskData) {
        try {
          console.log('Saving edited task:', taskData);
          
          const { error } = await supabaseClient
            .from('tasks_database')
            .update({
              client: taskData.client,
              subClient: taskData.subClient,
              category: taskData.category,
              documentType: taskData.documentType,
              status: taskData.status,
              notes: taskData.notes,
              date: taskData.date,
              updated_at: new Date().toISOString()
            })
            .eq('id', taskData.id);

          if (error) {
            console.error('Error saving task:', error);
            throw new Error(`Database error: ${error.message}`);
          }

          console.log('Task updated successfully');
          return true;
          
        } catch (error) {
          console.error('Error in saveEditedTask:', error);
          throw error;
        }
      }

      // Handle edit form submission
      document.getElementById('editTaskForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Check if current user is admin
        if (!currentUser || currentUser.role !== 'admin') {
          alert('❌ Access Denied: Only administrators can edit requests.');
          return;
        }

        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        submitButton.disabled = true;

        try {
          const taskData = {
            id: document.getElementById('editTaskId').value,
            client: document.getElementById('editClient').value.trim(),
            subClient: document.getElementById('editSubClient').value.trim(),
            category: document.getElementById('editCategory').value.trim(),
            documentType: document.getElementById('editDocumentType').value.trim(),
            status: document.getElementById('editStatus').value,
            notes: document.getElementById('editNotes').value.trim(),
            date: document.getElementById('editDate').value
          };

          // Validate required fields
          if (!taskData.client || !taskData.category || !taskData.documentType || !taskData.date) {
            throw new Error('Please fill in all required fields: Client, Category, Document Type, and Date');
          }

          await saveEditedTask(taskData);
          
          // Close lightbox and reload tasks
          document.getElementById('editTaskLightbox').style.display = 'none';
          showNotification('Task updated successfully!', 'success');
          loadTasks();
          
        } catch (error) {
          console.error('Error saving task:', error);
          alert('Error saving task: ' + error.message);
        } finally {
          submitButton.innerHTML = originalText;
          submitButton.disabled = false;
        }
      });

      // Close edit lightbox
      document.getElementById('closeEditLightbox').addEventListener('click', function() {
        document.getElementById('editTaskLightbox').style.display = 'none';
      });

      document.getElementById('cancelEditTask').addEventListener('click', function() {
        document.getElementById('editTaskLightbox').style.display = 'none';
      });

      document.getElementById('editTaskLightbox').addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });

      // Get random background color class with proper text contrast
      function getRandomBackgroundClass(index) {
        const colorClasses = [
          'card-bg-1', 'card-bg-2', 'card-bg-3', 'card-bg-4',
          'card-bg-5', 'card-bg-6', 'card-bg-7', 'card-bg-8',
          'card-bg-9', 'card-bg-10', 'card-bg-11', 'card-bg-12'
        ];
        return colorClasses[index % colorClasses.length];
      }

      // Get status badge color (adjusted for colored backgrounds)
      function getStatusColor(status) {
        switch(status) {
          case 'pending': return 'bg-red-500 bg-opacity-20 text-red-100';
          case 'in-progress': return 'bg-yellow-500 bg-opacity-20 text-yellow-100';
          case 'completed': return 'bg-green-500 bg-opacity-20 text-green-100';
          default: return 'bg-red-500 bg-opacity-20 text-red-100';
        }
      }

      // Update statistics
      function updateStats(tasks) {
        const pendingCount = tasks.filter(t => t.status === 'pending').length;
        const inProgressCount = tasks.filter(t => t.status === 'in-progress').length;
        const completedCount = tasks.filter(t => t.status === 'completed').length;

        document.getElementById('pendingCount').textContent = pendingCount;
        document.getElementById('inProgressCount').textContent = inProgressCount;
        document.getElementById('completedCount').textContent = completedCount;
      }

      // Update pagination controls
      function updatePagination() {
        const totalPages = Math.ceil(allTasks.length / tasksPerPage);
        const startIndex = (currentPage - 1) * tasksPerPage + 1;
        const endIndex = Math.min(currentPage * tasksPerPage, allTasks.length);
        
        // Update pagination info
        document.getElementById('paginationInfo').textContent = `Showing ${startIndex}-${endIndex} of ${allTasks.length}`;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        
        // Update button states
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
        document.getElementById('prevPageBottom').disabled = currentPage === 1;
        document.getElementById('nextPageBottom').disabled = currentPage === totalPages;
        document.getElementById('firstPage').disabled = currentPage === 1;
        document.getElementById('lastPage').disabled = currentPage === totalPages;
        
        // Generate page numbers
        const pageNumbersContainer = document.getElementById('pageNumbers');
        pageNumbersContainer.innerHTML = '';
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
          const pageButton = document.createElement('button');
          pageButton.className = `px-2 py-1 border rounded text-xs ${
            i === currentPage 
              ? 'bg-blue-600 text-white border-blue-600' 
              : 'border-gray-300 hover:bg-gray-50'
          }`;
          pageButton.textContent = i;
          pageButton.addEventListener('click', () => displayPage(i));
          pageNumbersContainer.appendChild(pageButton);
        }
      }

      // Show status update lightbox - ADMIN ONLY
      function showStatusUpdate(taskId, currentStatus) {
        // Check if current user is admin
        if (!currentUser || currentUser.role !== 'admin') {
          alert('❌ Access Denied: Only administrators can update request status.');
          return;
        }
        
        currentTaskId = taskId;
        
        let nextStatus, title, message;
        
        if (currentStatus === 'pending') {
          nextStatus = 'in-progress';
          title = 'Start Progress';
          message = 'Move this task from Pending to In Progress?';
        } else if (currentStatus === 'in-progress') {
          nextStatus = 'completed';
          title = 'Complete Task';
          message = 'Mark this task as Completed?';
        } else {
          return; // No further updates for completed tasks
        }
        
        currentNewStatus = nextStatus;
        
        document.getElementById('lightboxTitle').textContent = title;
        document.getElementById('lightboxMessage').textContent = message;
        document.getElementById('statusLightbox').style.display = 'block';
      }

      // Update task status with detailed error handling - ADMIN ONLY
      async function updateTaskStatus() {
        if (!currentTaskId || !currentNewStatus) return;
        
        // Double-check admin privileges
        if (!currentUser || currentUser.role !== 'admin') {
          alert('❌ Access Denied: Only administrators can update request status.');
          document.getElementById('statusLightbox').style.display = 'none';
          return;
        }

        try {
          console.log('Admin updating task:', currentTaskId, 'to status:', currentNewStatus);
          
          const { error } = await supabaseClient
            .from('tasks_database')
            .update({ 
              status: currentNewStatus,
              updated_at: new Date().toISOString()
            })
            .eq('id', currentTaskId);

          if (error) {
            console.error('Detailed update error:', error);
            throw new Error(`Database error: ${error.message} (Code: ${error.code})`);
          }

          // Close lightbox and reload tasks
          document.getElementById('statusLightbox').style.display = 'none';
          console.log('Task updated successfully by admin, reloading...');
          loadTasks();
          
        } catch (error) {
          console.error('Error updating task:', error);
          // Show detailed error to user
          alert('Error updating task status: ' + error.message);
        }
      }

      // Show error message
      function showError(message) {
        const container = document.getElementById('tasksContainer');
        container.innerHTML = 
          '<div class="col-span-full text-center text-red-500 py-6">' +
          '<i class="fas fa-exclamation-triangle text-xl mb-2"></i>' +
          '<p class="text-sm">' + message + '</p>' +
          '</div>';
      }

      // Pagination event listeners
      document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) displayPage(currentPage - 1);
      });

      document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < Math.ceil(allTasks.length / tasksPerPage)) displayPage(currentPage + 1);
      });

      document.getElementById('prevPageBottom').addEventListener('click', () => {
        if (currentPage > 1) displayPage(currentPage - 1);
      });

      document.getElementById('nextPageBottom').addEventListener('click', () => {
        if (currentPage < Math.ceil(allTasks.length / tasksPerPage)) displayPage(currentPage + 1);
      });

      document.getElementById('firstPage').addEventListener('click', () => {
        displayPage(1);
      });

      document.getElementById('lastPage').addEventListener('click', () => {
        displayPage(Math.ceil(allTasks.length / tasksPerPage));
      });

      // Event listeners for update confirmation
      document.getElementById('confirmUpdate').addEventListener('click', updateTaskStatus);
      document.getElementById('cancelUpdate').addEventListener('click', function() {
        document.getElementById('statusLightbox').style.display = 'none';
      });

      // Close lightbox when clicking outside
      document.getElementById('statusLightbox').addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });

      // Refresh button functionality
      document.getElementById('refreshButton').addEventListener('click', async function() {
        if (isRefreshing) return;
        
        isRefreshing = true;
        const button = this;
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-sync-alt refresh-spin"></i><span>Refreshing...</span>';
        button.disabled = true;
        
        try {
          await loadTasks();
          showNotification('Monitoring data refreshed successfully!', 'success');
        } catch (error) {
          console.error('Error refreshing data:', error);
          showNotification('Error refreshing data', 'error');
        } finally {
          setTimeout(() => {
            button.innerHTML = originalHtml;
            button.disabled = false;
            isRefreshing = false;
          }, 1000);
        }
      });

      function showNotification(message, type = "info") {
        const existingNotification = document.querySelector('.custom-notification');
        if (existingNotification) {
          existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `custom-notification fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-lg border-l-4 transform transition-all duration-300 ${
          type === 'success' 
            ? 'bg-green-50 text-green-800 border-green-400' 
            : type === 'error'
            ? 'bg-red-50 text-red-800 border-red-400'
            : 'bg-blue-50 text-blue-800 border-blue-400'
        }`;
        
        notification.innerHTML = `
          <div class="flex items-center">
            <i class="fas ${
              type === 'success' ? 'fa-check-circle' :
              type === 'error' ? 'fa-exclamation-circle' :
              'fa-info-circle'
            } mr-3"></i>
            <span>${message}</span>
          </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add('translate-x-0', 'opacity-100');
        }, 10);

        setTimeout(() => {
          notification.classList.remove('translate-x-0', 'opacity-100');
          notification.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, 5000);
      }

      // Initialize with authentication check
      document.addEventListener('DOMContentLoaded', checkAuth);

      // Auto-refresh every 2 minutes
      setInterval(() => {
        loadTasks();
      }, 120000);
    </script>
  </body>
</html>
