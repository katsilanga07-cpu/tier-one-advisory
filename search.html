<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search - Tier One Advisory (Ph) Inc.</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
      .header-gradient {
        background: linear-gradient(135deg, #0056a3 0%, #003d75 100%);
      }
      .search-results {
        max-height: 600px;
        overflow-y: auto;
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>

  <body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <!-- Top Bar -->
      <div class="bg-gray-800 text-white py-2">
        <div class="container mx-auto px-4">
          <div class="flex justify-between items-center text-sm">
            <div class="flex space-x-4">
              <a href="#" class="hover:text-blue-300 transition"><i class="fas fa-globe mr-1"></i> Philippines</a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fas fa-phone mr-1"></i> Contact Us</a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fas fa-user mr-1"></i> Login</a>
            </div>
            <div class="flex space-x-4">
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-linkedin"></i></a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-twitter"></i></a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-facebook"></i></a>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Navigation -->
      <nav class="header-gradient text-white">
        <div class="container mx-auto px-4">
          <div class="flex items-center justify-between py-4">
            <!-- Company Name -->
            <div class="flex items-center space-x-8">
              <a href="index.html" class="text-2xl font-bold text-white">
                Tier One Advisory (Ph) Inc.
              </a>
              
              <!-- Main Menu -->
              <div class="hidden md:flex space-x-6">
                <a href="index.html" class="hover:text-blue-200 transition">Dashboard</a>
                <a href="request-form.html" class="hover:text-blue-200 transition">Request Form</a>
                <a href="search.html" class="hover:text-blue-200 transition font-medium border-b-2 border-white">Search</a>
                <a href="monitoring.html" class="hover:text-blue-200 transition">Monitoring</a>
              </div>
            </div>

            <!-- Right Side Actions -->
            <div class="flex items-center space-x-4">
              <button id="searchButton" class="hover:text-blue-200 transition">
                <i class="fas fa-search"></i>
              </button>
              <button class="md:hidden hover:text-blue-200 transition">
                <i class="fas fa-bars text-xl"></i>
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Breadcrumb -->
      <div class="bg-gray-100 border-b">
        <div class="container mx-auto px-4 py-2">
          <nav class="text-sm">
            <ol class="list-none p-0 inline-flex">
              <li class="flex items-center">
                <a href="index.html" class="text-blue-600 hover:text-blue-800">Home</a>
                <span class="mx-2 text-gray-400">/</span>
              </li>
              <li class="flex items-center">
                <a href="index.html" class="text-blue-600 hover:text-blue-800">Dashboard</a>
                <span class="mx-2 text-gray-400">/</span>
              </li>
              <li class="text-gray-500">Search</li>
            </ol>
          </nav>
        </div>
      </div>
    </header>

    <!-- Search Content -->
    <main class="container mx-auto px-4 py-8">
      <!-- Page Title -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Search Requests</h1>
        <p class="text-gray-600">Find and filter document requests</p>
      </div>

      <!-- Search Form -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <!-- Omnibar Search -->
          <div class="lg:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-search mr-2"></i>Search All Fields
            </label>
            <input 
              type="text" 
              id="searchInput"
              placeholder="Search by client, category, document type, notes..."
              class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- Status Filter -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select id="statusFilter" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
              <option value="in-progress">In Progress</option>
            </select>
          </div>
        </div>

        <!-- Date Range -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
            <input 
              type="date" 
              id="fromDate"
              class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
            <input 
              type="date" 
              id="toDate"
              class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div class="flex items-end">
            <button 
              id="clearDates"
              class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition w-full"
            >
              <i class="fas fa-times mr-2"></i>Clear Dates
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-between">
          <div class="flex gap-4">
            <button 
              id="searchButtonMain"
              class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-medium"
            >
              <i class="fas fa-search mr-2"></i>Search
            </button>
            <button 
              id="resetButton"
              class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition font-medium"
            >
              <i class="fas fa-redo mr-2"></i>Reset
            </button>
          </div>
          <div class="flex gap-4">
            <button 
              id="exportPdfButton"
              class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-medium"
            >
              <i class="fas fa-file-pdf mr-2"></i>Export PDF
            </button>
            <button 
              id="printButton"
              class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-medium"
            >
              <i class="fas fa-print mr-2"></i>Print
            </button>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
          <h2 class="text-xl font-semibold text-gray-800">Search Results</h2>
          <div id="resultCount" class="text-sm text-gray-600">0 records found</div>
        </div>
        
        <div class="search-results">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub-Client</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Type</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
              </tr>
            </thead>
            <tbody id="searchResults" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                  <i class="fas fa-search text-3xl mb-3 text-gray-300"></i>
                  <p>Enter search criteria to find requests</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Search Modal -->
    <div id="searchModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
          <div class="p-6">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-semibold text-gray-800">Quick Search</h3>
              <button id="closeSearch" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
              </button>
            </div>
            
            <div class="relative mb-6">
              <input 
                type="text" 
                id="quickSearchInput"
                placeholder="Search by client name, category, or document type..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
              <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
            
            <div id="quickSearchResults" class="max-h-96 overflow-y-auto">
              <div class="text-center text-gray-500 py-8">
                <i class="fas fa-search text-3xl mb-3"></i>
                <p>Enter search terms to find requests</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12">
      <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="font-bold text-lg mb-4">Company</h3>
            <ul class="space-y-2">
              <li><a href="#" class="hover:text-blue-300 transition">About Us</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Leadership</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Careers</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">News</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-lg mb-4">Services</h3>
            <ul class="space-y-2">
              <li><a href="#" class="hover:text-blue-300 transition">All Services</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Industries</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Locations</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-lg mb-4">Support</h3>
            <ul class="space-y-2">
              <li><a href="#" class="hover:text-blue-300 transition">Contact Us</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Help Center</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-lg mb-4">Connect</h3>
            <div class="flex space-x-4">
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-linkedin text-xl"></i></a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-twitter text-xl"></i></a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-facebook text-xl"></i></a>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-700 mt-8 pt-6 text-center text-sm text-gray-400">
          <p>&copy; 2024 Tier One Advisory (Ph) Inc. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- JavaScript -->
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const SUPABASE_URL = "https://webdmcvcbfeytwhzonem.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYmRtY3ZjYmZleXR3aHpvbmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMDc5ODYsImV4cCI6MjA3Nzg4Mzk4Nn0.QlZeRqYvbdqNfRKrq_MIB0VBSM4ZcyeVtD_9O9uFAI8";
      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // Main search page elements
      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');
      const fromDate = document.getElementById('fromDate');
      const toDate = document.getElementById('toDate');
      const clearDates = document.getElementById('clearDates');
      const searchButtonMain = document.getElementById('searchButtonMain');
      const resetButton = document.getElementById('resetButton');
      const exportPdfButton = document.getElementById('exportPdfButton');
      const printButton = document.getElementById('printButton');
      const searchResults = document.getElementById('searchResults');
      const resultCount = document.getElementById('resultCount');

      // Quick search modal elements
      const searchButton = document.getElementById('searchButton');
      const searchModal = document.getElementById('searchModal');
      const closeSearch = document.getElementById('closeSearch');
      const quickSearchInput = document.getElementById('quickSearchInput');
      const quickSearchResults = document.getElementById('quickSearchResults');

      // Quick Search Functionality
      function initializeQuickSearch() {
        // Open search modal
        searchButton.addEventListener('click', function() {
          searchModal.classList.remove('hidden');
          quickSearchInput.focus();
        });

        // Close search modal
        closeSearch.addEventListener('click', function() {
          searchModal.classList.add('hidden');
          quickSearchInput.value = '';
          quickSearchResults.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              <i class="fas fa-search text-3xl mb-3"></i>
              <p>Enter search terms to find requests</p>
            </div>
          `;
        });

        // Close modal when clicking outside
        searchModal.addEventListener('click', function(e) {
          if (e.target === searchModal) {
            searchModal.classList.add('hidden');
            quickSearchInput.value = '';
            quickSearchResults.innerHTML = `
              <div class="text-center text-gray-500 py-8">
                <i class="fas fa-search text-3xl mb-3"></i>
                <p>Enter search terms to find requests</p>
              </div>
            `;
          }
        });

        // Quick search functionality
        quickSearchInput.addEventListener('input', debounce(function(e) {
          const searchTerm = e.target.value.trim();
          
          if (searchTerm.length < 2) {
            quickSearchResults.innerHTML = `
              <div class="text-center text-gray-500 py-8">
                <i class="fas fa-search text-3xl mb-3"></i>
                <p>Enter at least 2 characters to search</p>
              </div>
            `;
            return;
          }
          
          performQuickSearch(searchTerm);
        }, 300));
      }

      // Debounce function to limit API calls
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Perform quick search in Supabase
      async function performQuickSearch(searchTerm) {
        const quickSearchResults = document.getElementById('quickSearchResults');
        
        try {
          quickSearchResults.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              <i class="fas fa-spinner fa-spin text-blue-500 text-3xl mb-3"></i>
              <p>Searching...</p>
            </div>
          `;

          const { data: tasks, error } = await supabase
            .from('tasks_database')
            .select('*')
            .or(`client.ilike.%${searchTerm}%,subClient.ilike.%${searchTerm}%,category.ilike.%${searchTerm}%,documentType.ilike.%${searchTerm}%,notes.ilike.%${searchTerm}%`)
            .order('created_at', { ascending: false });

          if (error) throw error;

          displayQuickSearchResults(tasks, searchTerm);
        } catch (error) {
          console.error('Quick search error:', error);
          quickSearchResults.innerHTML = `
            <div class="text-center text-red-500 py-8">
              <i class="fas fa-exclamation-triangle text-2xl mb-3"></i>
              <p>Error performing search</p>
            </div>
          `;
        }
      }

      // Display quick search results
      function displayQuickSearchResults(tasks, searchTerm) {
        const quickSearchResults = document.getElementById('quickSearchResults');
        
        if (!tasks || tasks.length === 0) {
          quickSearchResults.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              <i class="fas fa-search text-3xl mb-3"></i>
              <p>No results found for "${searchTerm}"</p>
            </div>
          `;
          return;
        }

        let resultsHtml = '<div class="space-y-4">';
        
        tasks.forEach(task => {
          const statusColor = getStatusColor(task.status);
          
          resultsHtml += `
            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h4 class="font-semibold text-gray-800">${task.client} - ${task.subClient || 'No Sub-Client'}</h4>
                  <p class="text-sm text-gray-600">${new Date(task.date).toLocaleDateString()}</p>
                </div>
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                  ${task.status}
                </span>
              </div>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                  <span class="text-gray-600">Category:</span>
                  <span class="font-medium">${task.category}</span>
                </div>
                <div>
                  <span class="text-gray-600">Document:</span>
                  <span class="font-medium">${task.documentType}</span>
                </div>
              </div>
              ${task.notes ? `
                <div class="mt-2">
                  <p class="text-sm text-gray-600">Notes:</p>
                  <p class="text-sm text-gray-800 line-clamp-2">${task.notes}</p>
                </div>
              ` : ''}
            </div>
          `;
        });
        
        resultsHtml += '</div>';
        quickSearchResults.innerHTML = resultsHtml;
      }

      // Get status badge color
      function getStatusColor(status) {
        switch(status) {
          case 'pending': return 'bg-red-100 text-red-800';
          case 'in-progress': return 'bg-yellow-100 text-yellow-800';
          case 'completed': return 'bg-green-100 text-green-800';
          default: return 'bg-red-100 text-red-800';
        }
      }

      // Your existing main search page functions
      function setDefaultDates() {
          const today = new Date();
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(today.getDate() - 30);
          fromDate.value = thirtyDaysAgo.toISOString().split('T')[0];
          toDate.value = today.toISOString().split('T')[0];
      }

      async function performSearch() {
          const searchTerm = searchInput.value.trim();
          const status = statusFilter.value;
          const from = fromDate.value;
          const to = toDate.value;

          console.log('performSearch params:', { searchTerm, status, from, to });

          try {
              // start query builder
              let query = supabase.from('tasks_database').select('*');

              // build .or safely (avoid injecting commas from user input)
              if (searchTerm) {
                  const safeTerm = searchTerm.replace(/,/g, ' ');
                  const conditions = [
                      `client.ilike.%${safeTerm}%`,
                      `subClient.ilike.%${safeTerm}%`,
                      `category.ilike.%${safeTerm}%`,
                      `documentType.ilike.%${safeTerm}%`,
                      `notes.ilike.%${safeTerm}%`
                  ];
                  query = query.or(conditions.join(','));
              }

              if (status) query = query.eq('status', status);
              if (from) query = query.gte('date', from);
              if (to) query = query.lte('date', to);

              // order after filters
              query = query.order('created_at', { ascending: false });

              const { data, error } = await query;
              console.log('Supabase response:', { data, error });

              if (error) throw error;
              displayResults(data);
          } catch (error) {
              console.error('Search error:', error);
              searchResults.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-3"></i><p>Error loading results</p></td></tr>';
              resultCount.textContent = 'Error loading results';
          }
      }

      function displayResults(data) {
          if (!data || data.length === 0) {
              searchResults.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500"><i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i><p>No requests found</p></td></tr>';
              resultCount.textContent = '0 records found';
              return;
          }

          let resultsHtml = '';
          data.forEach(item => {
              let statusClass = 'bg-red-100 text-red-800';
              if (item.status === 'completed') statusClass = 'bg-green-100 text-green-800';
              if (item.status === 'in-progress') statusClass = 'bg-yellow-100 text-yellow-800';
              
              const date = new Date(item.date).toLocaleDateString();
              const client = item.client || '-';
              const subClient = item.subClient || '-';
              const category = item.category || '-';
              const documentType = item.documentType || '-';
              const status = item.status || 'pending';
              const notes = item.notes || '-';
              
              resultsHtml += '<tr class="hover:bg-gray-50">';
              resultsHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + date + '</td>';
              resultsHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + client + '</td>';
              resultsHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + subClient + '</td>';
              resultsHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + category + '</td>';
              resultsHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + documentType + '</td>';
              resultsHtml += '<td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ' + statusClass + '">' + status + '</span></td>';
              resultsHtml += '<td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">' + notes + '</td>';
              resultsHtml += '</tr>';
          });

          searchResults.innerHTML = resultsHtml;
          resultCount.textContent = data.length + ' record' + (data.length === 1 ? '' : 's') + ' found';
      }

      function exportToPDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Get date range from filters
          const fromDateValue = fromDate.value;
          const toDateValue = toDate.value;
          
          // Format dates for title (MMM/DD/YYYY)
          const formatDate = (dateString) => {
              if (!dateString) return 'N/A';
              const date = new Date(dateString);
              return date.toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: '2-digit', 
                  year: 'numeric' 
              });
          };
          
          const fromFormatted = formatDate(fromDateValue);
          const toFormatted = formatDate(toDateValue);
          
          // Get current data
          const rows = searchResults.querySelectorAll('tr');
          const data = [];
          
          // Extract data from table rows
          rows.forEach(row => {
              const cells = row.querySelectorAll('td');
              if (cells.length > 0) {
                  data.push({
                      date: cells[0].textContent.trim(),
                      client: cells[1].textContent.trim(),
                      subClient: cells[2].textContent.trim(),
                      category: cells[3].textContent.trim(),
                      documentType: cells[4].textContent.trim(),
                      status: cells[5].textContent.trim(),
                      notes: cells[6].textContent.trim()
                  });
              }
          });
          
          if (data.length === 0) {
              alert('No data to export');
              return;
          }
          
          // Group data by Client -> SubClient
          const groupedData = {};
          data.forEach(item => {
              if (!groupedData[item.client]) {
                  groupedData[item.client] = {};
              }
              if (!groupedData[item.client][item.subClient]) {
                  groupedData[item.client][item.subClient] = [];
              }
              groupedData[item.client][item.subClient].push(item);
          });
          
          // Define client priority order
          const clientPriority = [
              'Tier One Advisory',
              'Beyond Horizons', 
              'Cagayan Group'
          ];
          
          // Filter and sort clients according to priority order
          const orderedClients = clientPriority.filter(client => groupedData[client]);
          
          // PDF Styling
          const pageWidth = doc.internal.pageSize.getWidth();
          const margin = 20;
          let yPosition = margin;
          
          // Company Header
          doc.setFillColor(0, 86, 163); // Blue from your theme
          doc.rect(0, 0, pageWidth, 25, 'F');
          
          // Company Name
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(16);
          doc.setFont('helvetica', 'bold');
          doc.text('Tier One Advisory (Ph) Inc.', pageWidth / 2, 12, { align: 'center' });
          
          // Report Title
          doc.setFontSize(12);
          doc.text('Legal Department', pageWidth / 2, 20, { align: 'center' });
          
          yPosition = 40;
          
          // Main Report Title
          doc.setTextColor(0, 0, 0);
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.text(`Legal Department Monthly Report`, margin, yPosition);
          yPosition += 8;
          
          doc.setFontSize(11);
          doc.setFont('helvetica', 'normal');
          doc.text(`Report Period: ${fromFormatted} to ${toFormatted}`, margin, yPosition);
          yPosition += 15;
          
          // Generate Date
          const generatedDate = new Date().toLocaleDateString('en-US', { 
              month: 'long', 
              day: 'numeric', 
              year: 'numeric' 
          });
          doc.setFontSize(9);
          doc.setTextColor(100, 100, 100);
          doc.text(`Generated on: ${generatedDate}`, margin, yPosition);
          yPosition += 20;
          
          // Grouped Content by Client and SubClient (in priority order)
          let clientNumber = 1;
          
          orderedClients.forEach(client => {
              // Check for page break before adding new client section
              if (yPosition > 250) {
                  doc.addPage();
                  yPosition = margin;
              }
              
              // Client Header (e.g., "1. Tier One Advisory")
              doc.setTextColor(0, 0, 0);
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text(`${clientNumber}. ${client}`, margin, yPosition);
              yPosition += 8;
              
              const subClients = groupedData[client];
              let subClientNumber = 1;
              
              // Process subclients for this client
              Object.keys(subClients).forEach(subClient => {
                  // Check for page break before adding new subclient section
                  if (yPosition > 260) {
                      doc.addPage();
                      yPosition = margin;
                  }
                  
                  // SubClient Header (e.g., "1.1 Sub Client Name")
                  doc.setFontSize(11);
                  doc.setFont('helvetica', 'bold');
                  doc.text(`${clientNumber}.${subClientNumber} ${subClient}`, margin + 5, yPosition);
                  yPosition += 6;
                  
                  const items = subClients[subClient];
                  
                  items.forEach((item, index) => {
                      // Check for page break before adding new item
                      if (yPosition > 270) {
                          doc.addPage();
                          yPosition = margin;
                      }
                      
                      // Notes in bulleted format
                      if (item.notes && item.notes !== '-' && item.notes.trim() !== '') {
                          doc.setFontSize(10);
                          doc.setFont('helvetica', 'normal');
                          
                          // Bullet point
                          doc.text('â€¢', margin + 10, yPosition);
                          
                          // Split notes into lines that fit page width
                          const notesLines = doc.splitTextToSize(item.notes, pageWidth - margin - 20);
                          
                          // Add notes with justified alignment
                          doc.text(notesLines, margin + 15, yPosition, {
                              align: 'justify'
                          });
                          
                          // Move Y position based on number of lines
                          yPosition += (notesLines.length * 5) + 3;
                          
                          // Add small metadata for each note
                          doc.setFontSize(8);
                          doc.setTextColor(100, 100, 100);
                          const metadata = `Date: ${item.date} | Category: ${item.category} | Status: ${item.status}`;
                          doc.text(metadata, margin + 15, yPosition);
                          yPosition += 8;
                          
                          doc.setTextColor(0, 0, 0); // Reset color for next item
                      }
                  });
                  
                  subClientNumber++;
                  yPosition += 5; // Extra space between subclients
              });
              
              clientNumber++;
              yPosition += 10; // Extra space between clients
          });
          
          // Add page numbers
          const totalPages = doc.internal.getNumberOfPages();
          for (let i = 1; i <= totalPages; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.setTextColor(100, 100, 100);
              doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, doc.internal.pageSize.getHeight() - 10);
          }
          
          // Save the PDF
          doc.save(`Legal-Dept-Monthly-Report-${fromFormatted}-to-${toFormatted}.pdf`);
      }

      function printResults() {
          const printWindow = window.open('', '_blank');
          const tableHtml = document.querySelector('.search-results').innerHTML;
          const currentDate = new Date().toLocaleString();
          
          let printContent = '<html><head><title>Request Search Results</title><style>';
          printContent += 'body{font-family:Arial,sans-serif;margin:20px}';
          printContent += 'table{width:100%;border-collapse:collapse}';
          printContent += 'th,td{border:1px solid #ddd;padding:8px;text-align:left}';
          printContent += 'th{background-color:#f8f9fa}';
          printContent += 'tr:nth-child(even){background-color:#f2f2f2}';
          printContent += '.header{text-align:center;margin-bottom:20px}';
          printContent += '</style></head><body>';
          printContent += '<div class="header"><h1>Request Search Results</h1><p>Generated on ' + currentDate + '</p></div>';
          printContent += '<table>' + tableHtml + '</table>';
          printContent += '</body></html>';
          
          printWindow.document.write(printContent);
          printWindow.document.close();
          printWindow.print();
      }

      function resetForm() {
          searchInput.value = '';
          statusFilter.value = '';
          setDefaultDates();
          searchResults.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500"><i class="fas fa-search text-3xl mb-3 text-gray-300"></i><p>Enter search criteria to find requests</p></td></tr>';
          resultCount.textContent = '0 records found';
      }

      // Event Listeners for main search
      searchButtonMain.addEventListener('click', performSearch);
      resetButton.addEventListener('click', resetForm);
      clearDates.addEventListener('click', function() {
          fromDate.value = '';
          toDate.value = '';
      });
      exportPdfButton.addEventListener('click', exportToPDF);
      printButton.addEventListener('click', printResults);

      searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') performSearch();
      });

      // Initialize everything
      document.addEventListener('DOMContentLoaded', function() {
          setDefaultDates();
          initializeQuickSearch();
      });
    </script>
  </body>
</html>
