<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Management - Tier One Advisory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-button.active {
            background-color: white;
            color: #2563eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .header-gradient {
            background: linear-gradient(135deg, #0056a3 0%, #003d75 100%);
        }
        .nav-item {
            position: relative;
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
        }
        .tighter-margins {
            max-width: 1400px;
            margin: 0 auto;
        }
        .permission-notice {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <!-- Top Bar -->
        <div class="bg-gray-800 text-white py-1.5 text-xs">
            <div class="tighter-margins px-4">
                <div class="flex justify-between items-center">
                    <div class="flex space-x-3">
                        <a href="#" class="hover:text-blue-300 transition flex items-center">
                            <i class="fas fa-globe mr-1 text-xs"></i> Philippines
                        </a>
                        <a href="#" class="hover:text-blue-300 transition flex items-center">
                            <i class="fas fa-phone mr-1 text-xs"></i> Contact Us
                        </a>
                        <a href="#" id="logoutButton" class="hover:text-blue-300 transition cursor-pointer flex items-center">
                            <i class="fas fa-sign-out-alt mr-1 text-xs"></i> Logout
                        </a>
                    </div>
                    <div class="flex space-x-3">
                        <a href="#" class="hover:text-blue-300 transition">
                            <i class="fab fa-linkedin text-sm"></i>
                        </a>
                        <a href="#" class="hover:text-blue-300 transition">
                            <i class="fab fa-twitter text-sm"></i>
                        </a>
                        <a href="#" class="hover:text-blue-300 transition">
                            <i class="fab fa-facebook text-sm"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="header-gradient text-white shadow-lg">
            <div class="tighter-margins px-4">
                <div class="flex items-center justify-between">
                    <!-- Company Logo & Name -->
                    <div class="flex items-center space-x-6">
                        <a href="dashboard.html" class="flex items-center space-x-2 text-xl font-bold text-white">
                            <div class="w-8 h-8 bg-white rounded flex items-center justify-center">
                                <span class="text-blue-600 font-bold text-sm">T1</span>
                            </div>
                            <span class="hidden sm:block">Tier One Advisory Philippines Inc.</span>
                        </a>
                        
                        <!-- Main Menu -->
                        <div class="hidden md:flex space-x-0.5">
                            <a href="dashboard.html" class="nav-item">
                                Dashboard
                            </a>
                            <a href="request-form.html" class="nav-item">
                                Request Form
                            </a>
                            <a href="search.html" class="nav-item">
                                Search
                            </a>
                            <a href="monitoring.html" class="nav-item">
                                Monitoring
                            </a>
                            <a href="admin-approval.html" class="nav-item">
                                Approvals
                            </a>
                            <a href="admin-management.html" class="nav-item active">
                                Admin
                            </a>
                        </div>
                    </div>

                    <!-- Right Side Actions -->
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <button class="flex items-center space-x-1.5 p-1.5 hover:bg-white/10 rounded transition-all duration-200">
                                <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-xs"></i>
                                </div>
                                <span id="headerUserWelcome" class="text-xs font-medium hidden sm:block">Welcome, Admin!</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Breadcrumb -->
        <div class="bg-gray-100 border-b text-xs">
            <div class="tighter-margins px-4 py-1.5">
                <nav>
                    <ol class="list-none p-0 inline-flex">
                        <li class="flex items-center">
                            <a href="dashboard.html" class="text-blue-600 hover:text-blue-800">Home</a>
                            <span class="mx-1.5 text-gray-400">/</span>
                        </li>
                        <li class="text-gray-500">Admin Management</li>
                    </ol>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Admin Management</h1>
        
        <!-- Permission Notice -->
        <div class="permission-notice rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3"></i>
                <div>
                    <h3 class="font-semibold text-yellow-800">Database Permissions Required</h3>
                    <p class="text-yellow-700 text-sm">If you see 403 errors, you need to set up RLS policies in Supabase. Check the console for details.</p>
                </div>
            </div>
        </div>
        
        <!-- Tabs for different tables -->
        <div class="mb-6">
            <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                <button id="tabClients" class="tab-button active py-2 px-4 rounded-md font-medium transition" data-tab="clients">
                    Clients & Sub-Clients
                </button>
                <button id="tabCategories" class="tab-button py-2 px-4 rounded-md font-medium transition" data-tab="categories">
                    Categories & Documents
                </button>
            </div>
        </div>

        <!-- Clients & Sub-Clients Section -->
        <div id="clientsSection" class="tab-content active">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Add New Client/Sub-Client</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client</label>
                        <input type="text" id="newClient" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sub-Client</label>
                        <input type="text" id="newSubClient" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button id="addClientBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition w-full">
                            <i class="fas fa-plus mr-2"></i>Add
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Existing Clients & Sub-Clients</h2>
                <div class="mb-4">
                    <input type="text" id="searchClients" placeholder="Search clients..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="clientsList" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Clients will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Categories & Documents Section -->
        <div id="categoriesSection" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Add New Category/Document</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <input type="text" id="newCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document Type</label>
                        <input type="text" id="newDocument" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button id="addCategoryBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition w-full">
                            <i class="fas fa-plus mr-2"></i>Add
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Existing Categories & Documents</h2>
                <div class="mb-4">
                    <input type="text" id="searchCategories" placeholder="Search categories..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="categoriesList" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h3 class="text-xl font-semibold mb-4" id="modalTitle">Edit Item</h3>
                    <div id="modalContent">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="cancelEdit" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                        <button id="saveEdit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = "https://webdmcvcbfeytwhzonem.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYmRtY3ZjYmZleXR3aHpvbmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMDc5ODYsImV4cCI6MjA3Nzg4Mzk4Nn0.QlZeRqYvbdqNfRKrq_MIB0VBSM4ZcyeVtD_9O9uFAI8";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentEditingItem = null;
        let currentTable = null;

        // Simple tab functionality
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const targetContent = document.getElementById(targetTab + 'Section');
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    // Load data for the active tab
                    if (targetTab === 'clients') {
                        loadClientsData();
                    } else if (targetTab === 'categories') {
                        loadCategoriesData();
                    }
                });
            });
        }

        // Load clients data
        async function loadClientsData() {
            try {
                console.log('Loading clients data...');
                const { data, error } = await supabase
                    .from('sub_client')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase clients error:', error);
                    if (error.code === '42501') {
                        showPermissionError('clients');
                    }
                    throw error;
                }

                console.log('Clients data loaded:', data);
                displayClientsData(data);
            } catch (error) {
                console.error('Error loading clients:', error);
                if (error.code === '42501') {
                    showPermissionError('clients');
                } else {
                    alert('Error loading clients data: ' + error.message);
                }
            }
        }

        // Load categories data
        async function loadCategoriesData() {
            try {
                console.log('Loading categories data...');
                const { data, error } = await supabase
                    .from('category')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase categories error:', error);
                    if (error.code === '42501') {
                        showPermissionError('categories');
                    }
                    throw error;
                }

                console.log('Categories data loaded:', data);
                displayCategoriesData(data);
            } catch (error) {
                console.error('Error loading categories:', error);
                if (error.code === '42501') {
                    showPermissionError('categories');
                } else {
                    alert('Error loading categories data: ' + error.message);
                }
            }
        }

        // Show permission error message
        function showPermissionError(table) {
            const container = table === 'clients' ? document.getElementById('clientsList') : document.getElementById('categoriesList');
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <i class="fas fa-exclamation-circle text-red-500 text-xl mb-2"></i>
                    <h4 class="font-semibold text-red-800 mb-2">Permission Denied (403 Error)</h4>
                    <p class="text-red-700 text-sm mb-3">
                        You need to set up Row Level Security (RLS) policies for the ${table} table in Supabase.
                    </p>
                    <div class="text-xs text-red-600 bg-red-100 p-2 rounded">
                        <strong>Fix:</strong> Run the RLS SQL policies in Supabase SQL Editor
                    </div>
                </div>
            `;
        }

        // Display clients data
        function displayClientsData(clients) {
            const container = document.getElementById('clientsList');
            if (!clients || clients.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No clients found. Add your first client above.</p>';
                return;
            }

            container.innerHTML = clients.map(client => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition client-item">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-gray-800">${client.clientList || 'No Client'}</h3>
                            <p class="text-sm text-gray-600">${client.subClientList || 'No Sub-Client'}</p>
                            <p class="text-xs text-gray-500 mt-1">Created: ${new Date(client.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editItem('sub_client', ${client.id})" class="text-blue-600 hover:text-blue-800 transition">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem('sub_client', ${client.id})" class="text-red-600 hover:text-red-800 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Display categories data
        function displayCategoriesData(categories) {
            const container = document.getElementById('categoriesList');
            if (!categories || categories.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No categories found. Add your first category above.</p>';
                return;
            }

            container.innerHTML = categories.map(category => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-green-300 transition category-item">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-gray-800">${category.categoryList || 'No Category'}</h3>
                            <p class="text-sm text-gray-600">${category.documents || 'No Document Type'}</p>
                            <p class="text-xs text-gray-500 mt-1">Created: ${new Date(category.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editItem('category', ${category.id})" class="text-blue-600 hover:text-blue-800 transition">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem('category', ${category.id})" class="text-red-600 hover:text-red-800 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add new client
        document.getElementById('addClientBtn').addEventListener('click', async () => {
            const client = document.getElementById('newClient').value.trim();
            const subClient = document.getElementById('newSubClient').value.trim();

            if (!client) {
                alert('Please enter a client name');
                return;
            }

            try {
                const { error } = await supabase
                    .from('sub_client')
                    .insert([{
                        clientList: client,
                        subClientList: subClient || null,
                        created_at: new Date().toISOString()
                    }]);

                if (error) {
                    if (error.code === '42501') {
                        alert('Permission denied. You need to set up RLS policies in Supabase.');
                        return;
                    }
                    throw error;
                }

                document.getElementById('newClient').value = '';
                document.getElementById('newSubClient').value = '';
                loadClientsData();
                alert('Client added successfully!');
            } catch (error) {
                console.error('Error adding client:', error);
                alert('Error adding client: ' + error.message);
            }
        });

        // Add new category
        document.getElementById('addCategoryBtn').addEventListener('click', async () => {
            const category = document.getElementById('newCategory').value.trim();
            const documentType = document.getElementById('newDocument').value.trim();

            if (!category) {
                alert('Please enter a category name');
                return;
            }

            try {
                const { error } = await supabase
                    .from('category')
                    .insert([{
                        categoryList: category,
                        documents: documentType || null,
                        created_at: new Date().toISOString()
                    }]);

                if (error) {
                    if (error.code === '42501') {
                        alert('Permission denied. You need to set up RLS policies in Supabase.');
                        return;
                    }
                    throw error;
                }

                document.getElementById('newCategory').value = '';
                document.getElementById('newDocument').value = '';
                loadCategoriesData();
                alert('Category added successfully!');
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Error adding category: ' + error.message);
            }
        });

        // Edit item (unified function)
        window.editItem = async function(table, id) {
            try {
                const { data, error } = await supabase
                    .from(table)
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditingItem = data;
                currentTable = table;

                if (table === 'sub_client') {
                    document.getElementById('modalTitle').textContent = 'Edit Client';
                    document.getElementById('modalContent').innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Client</label>
                                <input type="text" id="editField1" value="${data.clientList || ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sub-Client</label>
                                <input type="text" id="editField2" value="${data.subClientList || ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('modalTitle').textContent = 'Edit Category';
                    document.getElementById('modalContent').innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <input type="text" id="editField1" value="${data.categoryList || ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Document Type</label>
                                <input type="text" id="editField2" value="${data.documents || ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    `;
                }

                document.getElementById('editModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading item for edit:', error);
                alert('Error loading data: ' + error.message);
            }
        };

        // Delete item (unified function)
        window.deleteItem = async function(table, id) {
            const itemType = table === 'sub_client' ? 'client' : 'category';
            if (!confirm(`Are you sure you want to delete this ${itemType}?`)) return;

            try {
                const { error } = await supabase
                    .from(table)
                    .delete()
                    .eq('id', id);

                if (error) {
                    if (error.code === '42501') {
                        alert('Permission denied. You need to set up RLS policies in Supabase.');
                        return;
                    }
                    throw error;
                }

                if (table === 'sub_client') {
                    loadClientsData();
                } else {
                    loadCategoriesData();
                }
                alert(`${itemType.charAt(0).toUpperCase() + itemType.slice(1)} deleted successfully!`);
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Error deleting item: ' + error.message);
            }
        };

        // Save edits
        document.getElementById('saveEdit').addEventListener('click', async () => {
            if (!currentEditingItem || !currentTable) return;

            try {
                const field1 = document.getElementById('editField1').value.trim();
                const field2 = document.getElementById('editField2').value.trim();

                let updateData = {};
                if (currentTable === 'sub_client') {
                    updateData = { 
                        clientList: field1, 
                        subClientList: field2 || null 
                    };
                } else {
                    updateData = { 
                        categoryList: field1, 
                        documents: field2 || null 
                    };
                }

                const { error } = await supabase
                    .from(currentTable)
                    .update(updateData)
                    .eq('id', currentEditingItem.id);

                if (error) {
                    if (error.code === '42501') {
                        alert('Permission denied. You need to set up RLS policies in Supabase.');
                        return;
                    }
                    throw error;
                }

                document.getElementById('editModal').classList.add('hidden');
                
                if (currentTable === 'sub_client') {
                    loadClientsData();
                } else {
                    loadCategoriesData();
                }

                alert('Changes saved successfully!');
            } catch (error) {
                console.error('Error saving changes:', error);
                alert('Error saving changes: ' + error.message);
            }
        });

        // Close modal
        document.getElementById('cancelEdit').addEventListener('click', () => {
            document.getElementById('editModal').classList.add('hidden');
        });

        // Search functionality
        document.getElementById('searchClients').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.client-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        document.getElementById('searchCategories').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.category-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin page loaded');
            
            // Check authentication
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }

            // Set up tabs and load initial data
            setupTabs();
            loadClientsData();
            
            console.log('Admin page initialized successfully');
        });
    </script>
</body>
</html>
