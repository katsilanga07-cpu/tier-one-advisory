<script>
    // Initialize Supabase
    const SUPABASE_URL = "https://webdmcvcbfeytwhzonem.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYmRtY3ZjYmZleXR3aHpvbmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMDc5ODYsImV4cCI6MjA3Nzg4Mzk4Nn0.QlZeRqYvbdqNfRKrq_MIB0VBSM4ZcyeVtD_9O9uFAI8";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentEditingItem = null;
    let currentTable = null;

    // Simple tab functionality
    function setupTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');
                
                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked button and corresponding content
                button.classList.add('active');
                const targetContent = document.getElementById(targetTab + 'Section');
                if (targetContent) {
                    targetContent.classList.add('active');
                }
                
                // Load data for the active tab
                if (targetTab === 'clients') {
                    loadClientsData();
                } else if (targetTab === 'categories') {
                    loadCategoriesData();
                }
            });
        });
    }

    // Load clients data
    async function loadClientsData() {
        try {
            const { data, error } = await supabase
                .from('sub_client')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;
            displayClientsData(data);
        } catch (error) {
            console.error('Error loading clients:', error);
            alert('Error loading clients data');
        }
    }

    // Load categories data
    async function loadCategoriesData() {
        try {
            const { data, error } = await supabase
                .from('category')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;
            displayCategoriesData(data);
        } catch (error) {
            console.error('Error loading categories:', error);
            alert('Error loading categories data');
        }
    }

    // Display clients data
    function displayClientsData(clients) {
        const container = document.getElementById('clientsList');
        if (!clients || clients.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No clients found</p>';
            return;
        }

        container.innerHTML = clients.map(client => `
            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition client-item">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-gray-800">${client.clientList || 'No Client'}</h3>
                        <p class="text-sm text-gray-600">${client.subClientList || 'No Sub-Client'}</p>
                        <p class="text-xs text-gray-500 mt-1">Created: ${new Date(client.created_at).toLocaleDateString()}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editItem('sub_client', ${client.id})" class="text-blue-600 hover:text-blue-800 transition">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteItem('sub_client', ${client.id})" class="text-red-600 hover:text-red-800 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Display categories data
    function displayCategoriesData(categories) {
        const container = document.getElementById('categoriesList');
        if (!categories || categories.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No categories found</p>';
            return;
        }

        container.innerHTML = categories.map(category => `
            <div class="border border-gray-200 rounded-lg p-4 hover:border-green-300 transition category-item">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-gray-800">${category.categoryList || 'No Category'}</h3>
                        <p class="text-sm text-gray-600">${category.documents || 'No Document Type'}</p>
                        <p class="text-xs text-gray-500 mt-1">Created: ${new Date(category.created_at).toLocaleDateString()}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editItem('category', ${category.id})" class="text-blue-600 hover:text-blue-800 transition">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteItem('category', ${category.id})" class="text-red-600 hover:text-red-800 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Add new client
    document.getElementById('addClientBtn').addEventListener('click', async () => {
        const client = document.getElementById('newClient').value.trim();
        const subClient = document.getElementById('newSubClient').value.trim();

        if (!client) {
            alert('Please enter a client name');
            return;
        }

        try {
            const { error } = await supabase
                .from('sub_client')
                .insert([{
                    clientList: client,
                    subClientList: subClient || null,
                    created_at: new Date().toISOString()
                }]);

            if (error) throw error;

            document.getElementById('newClient').value = '';
            document.getElementById('newSubClient').value = '';
            loadClientsData();
            alert('Client added successfully!');
        } catch (error) {
            console.error('Error adding client:', error);
            alert('Error adding client');
        }
    });

    // Add new category
    document.getElementById('addCategoryBtn').addEventListener('click', async () => {
        const category = document.getElementById('newCategory').value.trim();
        const documentType = document.getElementById('newDocument').value.trim();

        if (!category) {
            alert('Please enter a category name');
            return;
        }

        try {
            const { error } = await supabase
                .from('category')
                .insert([{
                    categoryList: category,
                    documents: documentType || null,
                    created_at: new Date().toISOString()
                }]);

            if (error) throw error;

            document.getElementById('newCategory').value = '';
            document.getElementById('newDocument').value = '';
            loadCategoriesData();
            alert('Category added successfully!');
        } catch (error) {
            console.error('Error adding category:', error);
            alert('Error adding category');
        }
    });

    // Edit item (unified function)
    window.editItem = async function(table, id) {
        try {
            const { data, error } = await supabase
                .from(table)
                .select('*')
                .eq('id', id)
                .single();

            if (error) throw error;

            currentEditingItem = data;
            currentTable = table;

            if (table === 'sub_client') {
                document.getElementById('modalTitle').textContent = 'Edit Client';
                document.getElementById('modalContent').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Client</label>
                            <input type="text" id="editField1" value="${data.clientList || ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sub-Client</label>
                            <input type="text" id="editField2" value="${data.subClientList || ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('modalTitle').textContent = 'Edit Category';
                document.getElementById('modalContent').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <input type="text" id="editField1" value="${data.categoryList || ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Document Type</label>
                            <input type="text" id="editField2" value="${data.documents || ''}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                `;
            }

            document.getElementById('editModal').classList.remove('hidden');
        } catch (error) {
            console.error('Error loading item for edit:', error);
            alert('Error loading data');
        }
    };

    // Delete item (unified function)
    window.deleteItem = async function(table, id) {
        const itemType = table === 'sub_client' ? 'client' : 'category';
        if (!confirm(`Are you sure you want to delete this ${itemType}?`)) return;

        try {
            const { error } = await supabase
                .from(table)
                .delete()
                .eq('id', id);

            if (error) throw error;

            if (table === 'sub_client') {
                loadClientsData();
            } else {
                loadCategoriesData();
            }
            alert(`${itemType.charAt(0).toUpperCase() + itemType.slice(1)} deleted successfully!`);
        } catch (error) {
            console.error('Error deleting item:', error);
            alert('Error deleting item');
        }
    };

    // Save edits
    document.getElementById('saveEdit').addEventListener('click', async () => {
        if (!currentEditingItem || !currentTable) return;

        try {
            const field1 = document.getElementById('editField1').value.trim();
            const field2 = document.getElementById('editField2').value.trim();

            let updateData = {};
            if (currentTable === 'sub_client') {
                updateData = { clientList: field1, subClientList: field2 || null };
            } else {
                updateData = { categoryList: field1, documents: field2 || null };
            }

            const { error } = await supabase
                .from(currentTable)
                .update(updateData)
                .eq('id', currentEditingItem.id);

            if (error) throw error;

            document.getElementById('editModal').classList.add('hidden');
            
            if (currentTable === 'sub_client') {
                loadClientsData();
            } else {
                loadCategoriesData();
            }

            alert('Changes saved successfully!');
        } catch (error) {
            console.error('Error saving changes:', error);
            alert('Error saving changes');
        }
    });

    // Close modal
    document.getElementById('cancelEdit').addEventListener('click', () => {
        document.getElementById('editModal').classList.add('hidden');
    });

    // Search functionality
    document.getElementById('searchClients').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.client-item').forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? 'block' : 'none';
        });
    });

    document.getElementById('searchCategories').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.category-item').forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? 'block' : 'none';
        });
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Check authentication
        const userData = localStorage.getItem('currentUser');
        if (!userData) {
            window.location.href = 'login.html';
            return;
        }

        setupTabs();
        loadClientsData(); // Load initial data
    });
</script>
