<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Request Form - Tier One Advisory Philippines Inc.</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      .header-gradient {
        background: linear-gradient(135deg, #0056a3 0%, #003d75 100%);
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        display: -moz-box;
        display: box;
        line-clamp: 2;
        box-orient: vertical;
        text-overflow: ellipsis;
      }
      .form-background {
        background: linear-gradient(to right, #CBE5AE, #94B447);
        min-height: 100vh;
      }
      .compact-header {
        padding: 0.75rem 0;
      }
      .compact-nav {
        padding: 0.5rem 0;
      }
      .tighter-margins {
        max-width: 1400px;
        margin: 0 auto;
      }
      .nav-item {
        position: relative;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
      }
      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
      }
      .nav-item.active {
        background: rgba(255, 255, 255, 0.2);
      }
      .compact-spacing {
        margin-bottom: 1.5rem;
      }
      .section-padding {
        padding: 1.5rem 0;
      }

      /* File upload styles */
      .file-upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
      }
      .file-upload-area:hover {
        border-color: #3b82f6;
      }
      .file-upload-area.dragover {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .file-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
      }
      .file-progress {
        background: #e2e8f0;
        border-radius: 0.25rem;
        overflow: hidden;
        height: 0.5rem;
        margin-top: 0.5rem;
      }
      .file-progress-bar {
        background: #10b981;
        height: 100%;
        transition: width 0.3s ease;
      }

      @media (max-width: 768px) {
        .tighter-margins {
          padding: 0 1rem;
        }
        .compact-header {
          padding: 0.5rem 0;
        }
        .nav-item {
          padding: 0.5rem 0.75rem;
          font-size: 0.8rem;
        }
      }
      .stats-card {
        padding: 1rem;
      }
      .quick-action-card {
        padding: 1.5rem;
      }
    </style>
  </head>

  <body class="form-background">
    <!-- Enhanced Compact Header -->
    <header class="bg-white shadow-sm">
      <!-- Top Bar - Made more compact -->
      <div class="bg-gray-800 text-white py-1.5 text-xs">
        <div class="tighter-margins px-4">
          <div class="flex justify-between items-center">
            <div class="flex space-x-3">
              <a href="#" class="hover:text-blue-300 transition flex items-center">
                <i class="fas fa-globe mr-1 text-xs"></i> Philippines
              </a>
              <a href="#" class="hover:text-blue-300 transition flex items-center">
                <i class="fas fa-phone mr-1 text-xs"></i> Contact Us
              </a>
              <a href="#" id="logoutButton" class="hover:text-blue-300 transition cursor-pointer flex items-center">
                <i class="fas fa-sign-out-alt mr-1 text-xs"></i> Logout
              </a>
            </div>
            <div class="flex space-x-3">
              <a href="#" class="hover:text-blue-300 transition">
                <i class="fab fa-linkedin text-sm"></i>
              </a>
              <a href="#" class="hover:text-blue-300 transition">
                <i class="fab fa-twitter text-sm"></i>
              </a>
              <a href="#" class="hover:text-blue-300 transition">
                <i class="fab fa-facebook text-sm"></i>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Navigation - More compact like SGS -->
      <nav class="header-gradient text-white shadow-lg compact-nav">
        <div class="tighter-margins px-4">
          <div class="flex items-center justify-between">
            <!-- Company Logo & Name -->
            <div class="flex items-center space-x-6">
              <a href="dashboard.html" class="flex items-center space-x-2 text-xl font-bold text-white">
                <div class="w-8 h-8 bg-white rounded flex items-center justify-center">
                  <span class="text-blue-600 font-bold text-sm">T1</span>
                </div>
                <span class="hidden sm:block">Tier One Advisory Philippines Inc.</span>
              </a>
              
              <!-- Main Menu - More compact -->
              <div class="hidden md:flex space-x-0.5">
                <a href="dashboard.html" class="nav-item">
                  Dashboard
                </a>
                <a href="request-form.html" class="nav-item active">
                  Request Form
                </a>
                <a href="search.html" class="nav-item">
                  Search
                </a>
                <a href="monitoring.html" class="nav-item">
                  Monitoring
                </a>
                <a href="admin-approval.html" class="nav-item">
                  Approvals
                </a>
              </div>
            </div>

            <!-- Right Side Actions - More compact -->
            <div class="flex items-center space-x-3">
              <button id="searchButton" class="p-1.5 hover:bg-white/10 rounded transition-all duration-200">
                <i class="fas fa-search text-sm"></i>
              </button>
              <div class="relative">
                <button class="flex items-center space-x-1.5 p-1.5 hover:bg-white/10 rounded transition-all duration-200">
                  <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-xs"></i>
                  </div>
                  <span id="headerUserWelcome" class="text-xs font-medium hidden sm:block">Welcome!</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Compact Breadcrumb -->
      <div class="bg-gray-100 border-b text-xs">
        <div class="tighter-margins px-4 py-1.5">
          <nav>
            <ol class="list-none p-0 inline-flex">
              <li class="flex items-center">
                <a href="dashboard.html" class="text-blue-600 hover:text-blue-800">Home</a>
                <span class="mx-1.5 text-gray-400">/</span>
              </li>
              <li class="flex items-center">
                <a href="dashboard.html" class="text-blue-600 hover:text-blue-800">Dashboard</a>
                <span class="mx-1.5 text-gray-400">/</span>
              </li>
              <li class="text-gray-500">Request Form</li>
            </ol>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="min-h-screen py-6">
      <div class="tighter-margins px-4">
        <!-- Page Header (like dashboard) -->
        <div class="compact-spacing">
          <h1 class="text-2xl font-bold text-gray-800">Request Form</h1>
          <p id="welcomeMessage" class="text-gray-600 mt-1 text-sm">Welcome back!</p>
        </div>

        <!-- Form Card -->
        <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-3xl mx-auto">
          <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">
            Please enter your request below
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Dropdown 1 -->
            <div>
              <label for="clientDropdown" class="block text-gray-700 font-medium mb-2 text-sm">
                Client
              </label>
              <select
                id="clientDropdown"
                class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
              >
                <option value="">-- Select Client --</option>
              </select>
            </div>

            <!-- Dropdown 2 -->
            <div>
              <label for="subClientDropdown" class="block text-gray-700 font-medium mb-2 text-sm">
                Sub-Client
              </label>
              <select
                id="subClientDropdown"
                class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
              >
                <option value="">-- Select Sub-Client --</option>
              </select>
            </div>

            <!-- Dropdown 3 -->
            <div>
              <label for="categoryDropdown" class="block text-gray-700 font-medium mb-2 text-sm">
                Category
              </label>
              <select
                id="categoryDropdown"
                class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
              >
                <option value="">-- Select Category --</option>
              </select>
            </div>

            <!-- Dropdown 4 -->
            <div>
              <label for="documentDropdown" class="block text-gray-700 font-medium mb-2 text-sm">
                Document Type
              </label>
              <select
                id="documentDropdown"
                class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
              >
                <option value="">-- Select Document Type --</option>
              </select>
            </div>
          </div>

          <!-- Notes and Date -->
          <div class="mt-4">
            <label for="notes" class="block text-gray-700 font-medium mb-2 text-sm">Notes</label>
            <textarea
              id="notes"
              rows="3"
              placeholder="Enter notes here..."
              class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
            ></textarea>
          </div>

          <div class="mt-3">
            <label for="date" class="block text-gray-700 font-medium mb-2 text-sm">Date</label>
            <input
              type="date"
              id="date"
              class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
            />
          </div>

          <!-- File Upload Section -->
          <div class="mt-6">
            <label class="block text-gray-700 font-medium mb-2 text-sm">
              Attach Documents
            </label>
            
            <!-- File Upload Area -->
            <div 
              id="fileUploadArea" 
              class="file-upload-area p-6 text-center cursor-pointer"
            >
              <input 
                type="file" 
                id="fileInput" 
                multiple 
                class="hidden"
                accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt"
              >
              <div class="flex flex-col items-center justify-center">
                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                <p class="text-sm text-gray-600 mb-1">
                  <span class="text-blue-600 font-medium">Click to upload</span> or drag and drop
                </p>
                <p class="text-xs text-gray-500">
                  PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, TXT (Max: 10MB per file)
                </p>
              </div>
            </div>

            <!-- Uploaded Files List -->
            <div id="fileList" class="mt-4 space-y-2 max-h-40 overflow-y-auto">
              <!-- Files will be listed here -->
            </div>
          </div>

          <!-- Save button -->
          <div class="mt-6 text-center">
            <button
              id="saveButton"
              class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition font-medium text-sm"
            >
              <i class="fas fa-save mr-2"></i>Save Request
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Search Modal -->
    <div id="searchModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold text-gray-800">Search Requests</h3>
              <button id="closeSearch" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            
            <div class="relative mb-4">
              <input 
                type="text" 
                id="searchInput"
                placeholder="Search by client name, category, or document type..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
              >
              <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
            
            <div id="searchResults" class="max-h-96 overflow-y-auto">
              <div class="text-center text-gray-500 py-6">
                <i class="fas fa-search text-2xl mb-2"></i>
                <p class="text-sm">Enter search terms to find requests</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer - More compact -->
    <footer class="bg-gray-800 text-white mt-8">
      <div class="tighter-margins px-4 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div>
            <h3 class="font-bold text-base mb-3">Company</h3>
            <ul class="space-y-1 text-sm">
              <li><a href="#" class="hover:text-blue-300 transition">About Us</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Leadership</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Careers</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">News</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-base mb-3">Services</h3>
            <ul class="space-y-1 text-sm">
              <li><a href="#" class="hover:text-blue-300 transition">All Services</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Industries</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Locations</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-base mb-3">Support</h3>
            <ul class="space-y-1 text-sm">
              <li><a href="#" class="hover:text-blue-300 transition">Contact Us</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Help Center</a></li>
              <li><a href="#" class="hover:text-blue-300 transition">Privacy Policy</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold text-base mb-3">Connect</h3>
            <div class="flex space-x-3">
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-linkedin"></i></a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-twitter"></i></a>
              <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-facebook"></i></a>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-700 mt-6 pt-4 text-center text-xs text-gray-400">
          <p>&copy; 2024 Tier One Advisory Philippines Inc. All rights reserved.</p>
        </div>
      </div>
    </footer>
    <script>
  // Global logout function
  async function logout() {
    try {
      const SUPABASE_URL = "https://webdmcvcbfeytwhzonem.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYmRtY3ZjYmZleXR3aHpvbmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMDc5ODYsImV4cCI6MjA3Nzg4Mzk4Nn0.QlZeRqYvbdqNfRKrq_MIB0VBSM4ZcyeVtD_9O9uFAI8";
      
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
          persistSession: false,
          autoRefreshToken: false,
          detectSessionInUrl: false
        }
      });
      
      await supabase.auth.signOut();
    } catch (error) {
      console.log('Logout error:', error);
    }
    localStorage.removeItem('currentUser');
    window.location.href = 'login.html';
  }

  // Initialize Supabase globally
  const SUPABASE_URL = "https://webdmcvcbfeytwhzonem.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlYmRtY3ZjYmZleXR3aHpvbmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMDc5ODYsImV4cCI6MjA3Nzg4Mzk4Nn0.QlZeRqYvbdqNfRKrq_MIB0VBSM4ZcyeVtD_9O9uFAI8";
  
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: {
      persistSession: false,
      autoRefreshToken: false,
      detectSessionInUrl: false
    }
  });

  // File upload functionality
  class FileUploadManager {
    constructor(supabaseClient) {
      this.files = [];
      this.maxFileSize = 10 * 1024 * 1024; // 10MB
      this.allowedTypes = [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'image/jpeg',
        'image/jpg',
        'image/png',
        'text/plain'
      ];
      this.supabase = supabaseClient; // Store Supabase client
    }

    init() {
      this.setupEventListeners();
    }

    setupEventListeners() {
      const fileInput = document.getElementById('fileInput');
      const fileUploadArea = document.getElementById('fileUploadArea');

      // Click to upload
      fileUploadArea.addEventListener('click', () => {
        fileInput.click();
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        this.handleFiles(e.target.files);
      });

      // Drag and drop
      fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
      });

      fileUploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
      });

      fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        this.handleFiles(e.dataTransfer.files);
      });
    }

    handleFiles(fileList) {
      for (let file of fileList) {
        if (this.validateFile(file)) {
          this.addFile(file);
        }
      }
      this.renderFileList();
    }

    validateFile(file) {
      // Check file size
      if (file.size > this.maxFileSize) {
        alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
        return false;
      }

      // Check file type
      if (!this.allowedTypes.includes(file.type)) {
        alert(`File "${file.name}" is not a supported file type.`);
        return false;
      }

      return true;
    }

    addFile(file) {
      const fileId = Date.now() + Math.random().toString(36).substr(2, 9);
      this.files.push({
        id: fileId,
        file: file,
        progress: 0,
        status: 'pending' // pending, uploading, completed, error
      });
    }

    removeFile(fileId) {
      this.files = this.files.filter(f => f.id !== fileId);
      this.renderFileList();
    }

    renderFileList() {
      const fileListContainer = document.getElementById('fileList');
      
      if (this.files.length === 0) {
        fileListContainer.innerHTML = '';
        return;
      }

      fileListContainer.innerHTML = this.files.map(file => `
        <div class="file-item" data-file-id="${file.id}">
          <div class="flex justify-between items-center">
            <div class="flex items-center space-x-2">
              <i class="fas fa-file text-gray-500"></i>
              <span class="text-sm font-medium truncate max-w-xs">${file.file.name}</span>
              <span class="text-xs text-gray-500">(${(file.file.size / 1024 / 1024).toFixed(2)} MB)</span>
            </div>
            <button 
              onclick="fileUploadManager.removeFile('${file.id}')" 
              class="text-red-500 hover:text-red-700 text-sm"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          ${file.status === 'uploading' ? `
            <div class="file-progress">
              <div class="file-progress-bar" style="width: ${file.progress}%"></div>
            </div>
          ` : ''}
          ${file.status === 'completed' ? `
            <div class="text-xs text-green-600 mt-1">
              <i class="fas fa-check-circle"></i> Uploaded successfully
            </div>
          ` : ''}
          ${file.status === 'error' ? `
            <div class="text-xs text-red-600 mt-1">
              <i class="fas fa-exclamation-circle"></i> Upload failed
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    async uploadFiles(taskId) {
      const uploadedFiles = [];
      
      for (let fileObj of this.files) {
        try {
          console.log('Uploading file:', fileObj.file.name);
          fileObj.status = 'uploading';
          this.renderFileList();

          const filePath = `tasks/${taskId}/${fileObj.file.name}`;
          console.log('File path:', filePath);
          
          const { data, error } = await this.supabase.storage
            .from('task-documents')
            .upload(filePath, fileObj.file, {
              cacheControl: '3600',
              upsert: false
            });

          if (error) {
            console.error('Upload error:', error);
            throw error;
          }

          console.log('‚úÖ File uploaded successfully:', data);

          // Get public URL
          const { data: urlData } = this.supabase.storage
            .from('task-documents')
            .getPublicUrl(filePath);

          console.log('Public URL:', urlData.publicUrl);

          uploadedFiles.push({
            name: fileObj.file.name,
            path: filePath,
            url: urlData.publicUrl,
            size: fileObj.file.size,
            type: fileObj.file.type
          });

          fileObj.status = 'completed';
          fileObj.progress = 100;

        } catch (error) {
          console.error('‚ùå Error uploading file:', error);
          fileObj.status = 'error';
        }
        
        this.renderFileList();
      }
      
      console.log('All files processed. Uploaded:', uploadedFiles.length);
      return uploadedFiles;
    }

    clearFiles() {
      this.files = [];
      this.renderFileList();
      document.getElementById('fileInput').value = '';
    }
  }

  // Initialize file upload manager with Supabase client
  const fileUploadManager = new FileUploadManager(supabase);

  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', function() {
    // ‚úÖ Elements - check each one individually
    const elements = {
      clientDropdown: document.getElementById("clientDropdown"),
      subClientDropdown: document.getElementById("subClientDropdown"),
      categoryDropdown: document.getElementById("categoryDropdown"),
      documentDropdown: document.getElementById("documentDropdown"),
      notesInput: document.getElementById("notes"),
      dateInput: document.getElementById("date"),
      saveButton: document.getElementById("saveButton"),
      searchButton: document.getElementById('searchButton'),
      searchModal: document.getElementById('searchModal'),
      closeSearch: document.getElementById('closeSearch'),
      searchInput: document.getElementById('searchInput'),
      searchResults: document.getElementById('searchResults'),
      logoutButton: document.getElementById('logoutButton'),
      fileInput: document.getElementById('fileInput'),
      fileUploadArea: document.getElementById('fileUploadArea'),
      fileList: document.getElementById('fileList')
    };

    console.log('All form elements:', elements);

    // Check which elements are missing
    const missingElements = Object.entries(elements)
      .filter(([name, element]) => !element)
      .map(([name]) => name);

    if (missingElements.length > 0) {
      console.error('Missing elements:', missingElements);
      
      if (!elements.clientDropdown || !elements.saveButton) {
        console.error('Required form elements not found');
        return;
      }
    }

    // Load user info from localStorage and display in header
    function loadUserInfo() {
      const userData = localStorage.getItem('currentUser');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          document.getElementById('headerUserWelcome').textContent = `Welcome, ${user.full_name}`;
          return user;
        } catch (e) {
          console.error('Error parsing user data:', e);
          return null;
        }
      }
      return null;
    }

    // Display welcome message with user name
    function displayWelcomeMessage() {
      const userData = localStorage.getItem('currentUser');
      if (userData) {
        const user = JSON.parse(userData);
        document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.full_name}`;
      }
    }

    // Check if user is logged in (for page protection)
    function checkAuth() {
      const user = loadUserInfo();
      if (!user) {
        console.log('No user found in localStorage, redirecting to login...');
        window.location.href = 'login.html';
        return false;
      }
      console.log('User authenticated:', user.full_name, 'Role:', user.role);
      return user;
    }

    // Test Supabase connection
    async function testConnection() {
      try {
        console.log("Testing Supabase connection...");
        const { data, error } = await supabase.from('sub_client').select('count', { count: 'exact', head: true });
        
        if (error) {
          console.error("‚ùå Supabase connection failed:", error);
          return false;
        }
        
        console.log("‚úÖ Supabase connection successful");
        return true;
      } catch (err) {
        console.error("‚ùå Connection test exception:", err);
        return false;
      }
    }

    // üü¢ Load Clients
    async function loadClients() {
      console.log("Fetching clients from Supabase...");
      try {
        const { data, error } = await supabase.from("sub_client").select("clientList");
        
        if (error) {
          console.error("Error fetching clients:", error);
          return;
        }

        console.log("Client data:", data);
        
        if (!data || data.length === 0) {
          console.warn("No client data found");
          return;
        }

        const uniqueClients = [...new Set(data.map((item) => item.clientList))];
        
        // Clear existing options first
        elements.clientDropdown.innerHTML = '<option value="">-- Select Client --</option>';
        
        uniqueClients.forEach((client) => {
          const option = document.createElement("option");
          option.value = client;
          option.textContent = client;
          elements.clientDropdown.appendChild(option);
        });

        console.log("Dropdown populated with clients.");
      } catch (err) {
        console.error("Exception in loadClients:", err);
      }
    }

    // üü° Load Sub-Clients
    async function loadSubClients(selectedClient) {
      try {
        const { data, error } = await supabase
          .from("sub_client")
          .select("subClientList")
          .eq("clientList", selectedClient);
          
        if (error) {
          console.error("Error loading sub-clients:", error);
          return;
        }

        elements.subClientDropdown.innerHTML = '<option value="">-- Select Sub-Client --</option>';
        
        if (data && data.length > 0) {
          data.forEach((row) => {
            const option = document.createElement("option");
            option.value = row.subClientList;
            option.textContent = row.subClientList;
            elements.subClientDropdown.appendChild(option);
          });
        }
      } catch (err) {
        console.error("Exception in loadSubClients:", err);
      }
    }

    // üü£ Load Categories
    async function loadCategories() {
      console.log("Fetching categories from Supabase...");
      try {
        const { data, error } = await supabase.from("category").select("categoryList");
        
        if (error) {
          console.error("Error fetching categories:", error);
          return;
        }

        console.log("Category data:", data);
        
        if (!data || data.length === 0) {
          console.warn("No category data found");
          return;
        }

        const uniqueCategories = [...new Set(data.map((item) => item.categoryList))];

        // Clear existing options first
        elements.categoryDropdown.innerHTML = '<option value="">-- Select Category --</option>';
        
        uniqueCategories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          elements.categoryDropdown.appendChild(option);
        });

        console.log("Dropdown populated with categories.");
      } catch (err) {
        console.error("Exception in loadCategories:", err);
      }
    }

    // üîµ Load Documents
    async function loadDocuments(selectedCategory) {
      try {
        const { data, error } = await supabase
          .from("category")
          .select("documents")
          .eq("categoryList", selectedCategory);

        if (error) {
          console.error("Error loading documents:", error);
          return;
        }

        elements.documentDropdown.innerHTML = '<option value="">-- Select Document Type --</option>';

        if (data && data.length > 0) {
          data.forEach((row) => {
            if (row.documents) {
              const option = document.createElement("option");
              option.value = row.documents;
              option.textContent = row.documents;
              elements.documentDropdown.appendChild(option);
            }
          });
        }
      } catch (err) {
        console.error("Exception in loadDocuments:", err);
      }
    }

    // üíæ Save task - ENHANCED WITH BETTER FILE UPLOAD
    async function saveTask() {
      const client = elements.clientDropdown.value;
      const subClient = elements.subClientDropdown.value;
      const category = elements.categoryDropdown.value;
      const documentType = elements.documentDropdown.value;
      const notes = elements.notesInput.value;
      const date = elements.dateInput.value;

      if (!client || !category || !documentType || !date) {
        alert("Please select all required fields before saving.");
        return;
      }

      try {
        // Get current user from localStorage
        const userData = localStorage.getItem('currentUser');
        if (!userData) {
          alert("‚ùå Please log in to submit requests.");
          window.location.href = 'login.html';
          return;
        }

        const user = JSON.parse(userData);

        console.log('Starting to save task...');
        console.log('Files to upload:', fileUploadManager.files.length);

        // First, save the task to get an ID
        const taskData = {
          client: client,
          subClient: subClient || null,
          category: category,
          documentType: documentType,
          notes: notes || null,
          date: date,
          status: 'pending',
          created_at: new Date().toISOString(),
          requester_id: user.id,
          requester: user.full_name,
          approved_by: null,
          attachments: [] // Start with empty array
        };

        console.log('Saving task data:', taskData);

        const { data: insertedTask, error: insertError } = await supabase
          .from("tasks_database")
          .insert([taskData])
          .select();

        if (insertError) {
          console.error('Error saving to tasks_database:', insertError);
          alert("‚ùå Error saving task: " + insertError.message);
          return;
        }

        const taskId = insertedTask[0].id;
        console.log('‚úÖ Task saved with ID:', taskId);

        // Upload files if any
        if (fileUploadManager.files.length > 0) {
          console.log('Starting file upload for', fileUploadManager.files.length, 'files');
          const uploadedFiles = await fileUploadManager.uploadFiles(taskId);
          console.log('Files uploaded:', uploadedFiles);

          // Update task with file URLs
          if (uploadedFiles.length > 0) {
            const { error: updateError } = await supabase
              .from("tasks_database")
              .update({ 
                attachments: uploadedFiles,
                updated_at: new Date().toISOString()
              })
              .eq('id', taskId);

            if (updateError) {
              console.error('Error updating task with attachments:', updateError);
              alert("‚ö†Ô∏è Task saved but file links couldn't be updated: " + updateError.message);
            } else {
              console.log('‚úÖ Task updated with attachments');
            }
          }
        } else {
          console.log('No files to upload');
        }

        alert("‚úÖ Request submitted successfully!");
        resetForm();
        fileUploadManager.clearFiles();

      } catch (err) {
        console.error("Exception in saveTask:", err);
        alert("‚ùå Error saving task. Please check console for details.");
      }
    }

    function resetForm() {
      elements.clientDropdown.value = '';
      elements.subClientDropdown.innerHTML = '<option value="">-- Select Sub-Client --</option>';
      elements.categoryDropdown.value = '';
      elements.documentDropdown.innerHTML = '<option value="">-- Select Document Type --</option>';
      elements.notesInput.value = '';
      
      // Set default date to today
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      elements.dateInput.value = formattedDate;
    }

    // üß≠ Event Listeners for form
    elements.clientDropdown.addEventListener("change", () => {
      const selectedClient = elements.clientDropdown.value;
      elements.subClientDropdown.innerHTML = '<option value="">-- Select Sub-Client --</option>';
      if (selectedClient) loadSubClients(selectedClient);
    });

    elements.categoryDropdown.addEventListener("change", () => {
      const selectedCategory = elements.categoryDropdown.value;
      elements.documentDropdown.innerHTML = '<option value="">-- Select Document Type --</option>';
      if (selectedCategory) loadDocuments(selectedCategory);
    });

    elements.saveButton.addEventListener("click", saveTask);

    // ADDED: Logout button event listener
    elements.logoutButton.addEventListener('click', logout);

    // Search functionality
    function initializeSearch() {
      // Open search modal
      elements.searchButton.addEventListener('click', function() {
        elements.searchModal.classList.remove('hidden');
        elements.searchInput.focus();
      });

      // Close search modal
      elements.closeSearch.addEventListener('click', function() {
        elements.searchModal.classList.add('hidden');
        elements.searchInput.value = '';
        elements.searchResults.innerHTML = `
          <div class="text-center text-gray-500 py-6">
            <i class="fas fa-search text-2xl mb-2"></i>
            <p class="text-sm">Enter search terms to find requests</p>
          </div>
        `;
      });

      // Close modal when clicking outside
      elements.searchModal.addEventListener('click', function(e) {
        if (e.target === elements.searchModal) {
          elements.searchModal.classList.add('hidden');
          elements.searchInput.value = '';
          elements.searchResults.innerHTML = `
            <div class="text-center text-gray-500 py-6">
              <i class="fas fa-search text-2xl mb-2"></i>
              <p class="text-sm">Enter search terms to find requests</p>
            </div>
          `;
        }
      });

      // Search functionality
      elements.searchInput.addEventListener('input', debounce(function(e) {
        const searchTerm = e.target.value.trim();
        
        if (searchTerm.length < 2) {
          elements.searchResults.innerHTML = `
            <div class="text-center text-gray-500 py-6">
              <i class="fas fa-search text-2xl mb-2"></i>
              <p class="text-sm">Enter at least 2 characters to search</p>
            </div>
          `;
          return;
        }
        
        performSearch(searchTerm);
      }, 300));
    }

    // Debounce function to limit API calls
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Perform search in Supabase
    async function performSearch(searchTerm) {
      try {
        elements.searchResults.innerHTML = `
          <div class="text-center text-gray-500 py-6">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl mb-2"></i>
            <p class="text-sm">Searching...</p>
          </div>
        `;

        const { data: tasks, error } = await supabase
          .from('tasks_database')
          .select('*')
          .or(`client.ilike.%${searchTerm}%,subClient.ilike.%${searchTerm}%,category.ilike.%${searchTerm}%,documentType.ilike.%${searchTerm}%,notes.ilike.%${searchTerm}%`)
          .order('created_at', { ascending: false });

        if (error) throw error;

        displaySearchResults(tasks, searchTerm);
      } catch (error) {
        console.error('Search error:', error);
        elements.searchResults.innerHTML = `
          <div class="text-center text-red-500 py-6">
            <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
            <p class="text-sm">Error performing search</p>
          </div>
        `;
      }
    }

    // Display search results
    function displaySearchResults(tasks, searchTerm) {
      if (!tasks || tasks.length === 0) {
        elements.searchResults.innerHTML = `
          <div class="text-center text-gray-500 py-6">
            <i class="fas fa-search text-2xl mb-2"></i>
            <p class="text-sm">No results found for "${searchTerm}"</p>
          </div>
        `;
        return;
      }

      let resultsHtml = '<div class="space-y-3">';
      
      tasks.forEach(task => {
        const statusColor = getStatusColor(task.status);
        
        resultsHtml += `
          <div class="border border-gray-200 rounded-lg p-3 hover:border-blue-300 transition">
            <div class="flex justify-between items-start mb-2">
              <div>
                <h4 class="font-semibold text-gray-800 text-sm">${task.client} - ${task.subClient || 'No Sub-Client'}</h4>
                <p class="text-xs text-gray-600">${new Date(task.date).toLocaleDateString()}</p>
              </div>
              <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                ${task.status}
              </span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>
                <span class="text-gray-600">Category:</span>
                <span class="font-medium">${task.category}</span>
              </div>
              <div>
                <span class="text-gray-600">Document:</span>
                <span class="font-medium">${task.documentType}</span>
              </div>
            </div>
            ${task.notes ? `
              <div class="mt-2">
                <p class="text-xs text-gray-600">Notes:</p>
                <p class="text-xs text-gray-800 line-clamp-2">${task.notes}</p>
              </div>
            ` : ''}
            ${task.attachments && task.attachments.length > 0 ? `
              <div class="mt-2">
                <p class="text-xs text-gray-600">Attachments:</p>
                <div class="flex flex-wrap gap-1 mt-1">
                  ${task.attachments.map(att => `
                    <a href="${att.url}" target="_blank" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition">
                      <i class="fas fa-file mr-1"></i>${att.name}
                    </a>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      resultsHtml += '</div>';
      elements.searchResults.innerHTML = resultsHtml;
    }

    // Get status badge color
    function getStatusColor(status) {
      switch(status) {
        case 'pending': return 'bg-red-100 text-red-800';
        case 'in-progress': return 'bg-yellow-100 text-yellow-800';
        case 'completed': return 'bg-green-100 text-green-800';
        default: return 'bg-red-100 text-red-800';
      }
    }

    // Initialize everything
    async function initializeApp() {
      // Check if user is logged in using our localStorage method
      const user = checkAuth(); // This will redirect to login if not authenticated
      if (!user) return;

      console.log("User logged in:", user.full_name, "Role:", user.role);
      displayWelcomeMessage();
      
      // Initialize file upload manager
      fileUploadManager.init();
      
      // Test Supabase connection but don't block if it fails
      try {
        const connectionOk = await testConnection();
        if (connectionOk) {
          await loadClients();
          await loadCategories();
          initializeSearch();
          
          // Set default date to today
          const today = new Date();
          const formattedDate = today.toISOString().split('T')[0];
          elements.dateInput.value = formattedDate;
          
          console.log("‚úÖ App initialized successfully");
        } else {
          console.error("‚ùå Connection issues, but continuing with limited functionality");
          // Still allow form access even if DB connection fails
          await loadClients();
          await loadCategories();
          initializeSearch();
          
          const today = new Date();
          const formattedDate = today.toISOString().split('T')[0];
          elements.dateInput.value = formattedDate;
        }
      } catch (error) {
        console.error("Error during initialization:", error);
        // Still allow form access even if initialization fails
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        elements.dateInput.value = formattedDate;
      }
    }
    
    // Initialize the application
    initializeApp();
  });
    </script>
  </body>
</html>

